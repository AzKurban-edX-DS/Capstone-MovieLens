% Options for packages loaded elsewhere
\PassOptionsToPackage{unicode}{hyperref}
\PassOptionsToPackage{hyphens}{url}
\PassOptionsToPackage{dvipsnames,svgnames,x11names}{xcolor}
%
\documentclass[
]{article}
\usepackage{amsmath,amssymb}
\usepackage{iftex}
\ifPDFTeX
  \usepackage[T1]{fontenc}
  \usepackage[utf8]{inputenc}
  \usepackage{textcomp} % provide euro and other symbols
\else % if luatex or xetex
  \usepackage{unicode-math} % this also loads fontspec
  \defaultfontfeatures{Scale=MatchLowercase}
  \defaultfontfeatures[\rmfamily]{Ligatures=TeX,Scale=1}
\fi
\usepackage{lmodern}
\ifPDFTeX\else
  % xetex/luatex font selection
\fi
% Use upquote if available, for straight quotes in verbatim environments
\IfFileExists{upquote.sty}{\usepackage{upquote}}{}
\IfFileExists{microtype.sty}{% use microtype if available
  \usepackage[]{microtype}
  \UseMicrotypeSet[protrusion]{basicmath} % disable protrusion for tt fonts
}{}
\makeatletter
\@ifundefined{KOMAClassName}{% if non-KOMA class
  \IfFileExists{parskip.sty}{%
    \usepackage{parskip}
  }{% else
    \setlength{\parindent}{0pt}
    \setlength{\parskip}{6pt plus 2pt minus 1pt}}
}{% if KOMA class
  \KOMAoptions{parskip=half}}
\makeatother
\usepackage{xcolor}
\usepackage[margin=1in]{geometry}
\usepackage{color}
\usepackage{fancyvrb}
\newcommand{\VerbBar}{|}
\newcommand{\VERB}{\Verb[commandchars=\\\{\}]}
\DefineVerbatimEnvironment{Highlighting}{Verbatim}{commandchars=\\\{\}}
% Add ',fontsize=\small' for more characters per line
\usepackage{framed}
\definecolor{shadecolor}{RGB}{248,248,248}
\newenvironment{Shaded}{\begin{snugshade}}{\end{snugshade}}
\newcommand{\AlertTok}[1]{\textcolor[rgb]{0.94,0.16,0.16}{#1}}
\newcommand{\AnnotationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\AttributeTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{#1}}
\newcommand{\BaseNTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\BuiltInTok}[1]{#1}
\newcommand{\CharTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\CommentTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\CommentVarTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\ConstantTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{#1}}
\newcommand{\ControlFlowTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\DataTypeTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{#1}}
\newcommand{\DecValTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\DocumentationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\ErrorTok}[1]{\textcolor[rgb]{0.64,0.00,0.00}{\textbf{#1}}}
\newcommand{\ExtensionTok}[1]{#1}
\newcommand{\FloatTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\FunctionTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\ImportTok}[1]{#1}
\newcommand{\InformationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\KeywordTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\NormalTok}[1]{#1}
\newcommand{\OperatorTok}[1]{\textcolor[rgb]{0.81,0.36,0.00}{\textbf{#1}}}
\newcommand{\OtherTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{#1}}
\newcommand{\PreprocessorTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\RegionMarkerTok}[1]{#1}
\newcommand{\SpecialCharTok}[1]{\textcolor[rgb]{0.81,0.36,0.00}{\textbf{#1}}}
\newcommand{\SpecialStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\StringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\VariableTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\VerbatimStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\WarningTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\usepackage{graphicx}
\makeatletter
\def\maxwidth{\ifdim\Gin@nat@width>\linewidth\linewidth\else\Gin@nat@width\fi}
\def\maxheight{\ifdim\Gin@nat@height>\textheight\textheight\else\Gin@nat@height\fi}
\makeatother
% Scale images if necessary, so that they will not overflow the page
% margins by default, and it is still possible to overwrite the defaults
% using explicit options in \includegraphics[width, height, ...]{}
\setkeys{Gin}{width=\maxwidth,height=\maxheight,keepaspectratio}
% Set default figure placement to htbp
\makeatletter
\def\fps@figure{htbp}
\makeatother
\setlength{\emergencystretch}{3em} % prevent overfull lines
\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}
\setcounter{secnumdepth}{-\maxdimen} % remove section numbering
\usepackage{awesomebox}
\usepackage{hyperref}
\usepackage[natbib=true, style=numeric, backref=true, sorting=none]{biblatex}
\hypersetup{backref, pdfpagemode=Normal, colorlinks=true, implicit=false}
\ifLuaTeX
  \usepackage{selnolig}  % disable illegal ligatures
\fi
\usepackage[]{biblatex}
\addbibresource{references.bib}
\usepackage{bookmark}
\IfFileExists{xurl.sty}{\usepackage{xurl}}{} % add URL line breaks if available
\urlstyle{same}
\hypersetup{
  pdftitle={Capstone Movielens Report},
  pdfauthor={Azamat Kurbanaev},
  colorlinks=true,
  linkcolor={red},
  filecolor={Maroon},
  citecolor={blue},
  urlcolor={Blue},
  pdfcreator={LaTeX via pandoc}}

\title{Capstone Movielens Report}
\author{Azamat Kurbanaev}
\date{2025-05-06}

\begin{document}
\maketitle

{
\hypersetup{linkcolor=}
\setcounter{tocdepth}{2}
\tableofcontents
}
\newenvironment{infobox}[1]
  {
  \begin{itemize}
  \renewcommand{\labelitemi}{
    \raisebox{-.7\height}[0pt][0pt]{
      {\setkeys{Gin}{width=3em,keepaspectratio}
        \includegraphics{images/#1}}
    }
  }
  \setlength{\fboxsep}{1em}
  \begin{blackbox}
  \item
  }
  {
  \end{blackbox}
  \end{itemize}
  }

\subsection{Introduction / Overview / Executive
Summary}\label{introduction-overview-executive-summary}

The goal of the project is to build a Recommendation System using a
\href{http://grouplens.org/datasets/movielens/10m/}{10M version of the
MovieLens dataset}. Following the
\href{https://archive.nytimes.com/bits.blogs.nytimes.com/2009/09/21/netflix-awards-1-million-prize-and-starts-a-new-contest/index.html}{Netflix
Grand Prize Contest} requirements, we will evaluate the \emph{Root Mean
Square Error} (\emph{RMSE}) score, which, as shown in
\href{https://rafalab.dfci.harvard.edu/dsbook-part-2/highdim/regularization.html\#sec-netflix-loss-function}{Section
23.2 Loss function} of the \emph{Course Textbook}, is defined as: \[
\mbox{RMSE} = \sqrt{\frac{1}{N} \sum_{i,j}^{N} (y_{i,j} - \hat{y}_{i,j})^2}
\]

with \(N\) being the number of user/movie combinations for which we make
predictions and the sum occurring over all these
combinations\autocite{IDS2_23-2}.

Our goal is to achieve a value of less than 0.86490 (compare with the
\emph{Netflix Grand Prize} requirement: of at least
0.8563\autocite{BigChaosSln}).

\subsubsection{Datasets Overview}\label{datasets-overview}

To start with we have to generate two datasets derived from the
\emph{MovieLens} one mentioned above:

\begin{itemize}
\tightlist
\item
  \textbf{edx:} we use it to develop and train our algorithms;
\item
  \textbf{final\_holdout\_test:} according to the course requirements,
  we use it exclusively to evaluate the \emph{\textbf{RMSE}} of our
  final algorithm.
\end{itemize}

For this purpose the following package has been developed by the author
of this report: \texttt{edx.capstone.movielens.data}. The source code of
the package is available
\href{https://github.com/AzKurban-edX-DS/edx.capstone.movielens.data}{on
GitHub}\autocite{edx_capstone_movielens_data}.

Let's install the development version of this package from the GitHub
repository and attach the correspondent library to the global
environment:

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{if}\NormalTok{(}\SpecialCharTok{!}\FunctionTok{require}\NormalTok{(edx.capstone.movielens.data)) pak}\SpecialCharTok{::}\FunctionTok{pak}\NormalTok{(}\StringTok{"AzKurban{-}edX{-}DS/edx.capstone.movielens.data"}\NormalTok{)}

\FunctionTok{library}\NormalTok{(edx.capstone.movielens.data)}
\NormalTok{edx }\OtherTok{\textless{}{-}}\NormalTok{ edx.capstone.movielens.data}\SpecialCharTok{::}\NormalTok{edx}
\NormalTok{final\_holdout\_test }\OtherTok{\textless{}{-}}\NormalTok{ edx.capstone.movielens.data}\SpecialCharTok{::}\NormalTok{final\_holdout\_test}
\end{Highlighting}
\end{Shaded}

Now, we have the datasets listed above:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{summary}\NormalTok{(edx)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##      userId         movieId          rating        timestamp            title              genres         
##  Min.   :    1   Min.   :    1   Min.   :0.500   Min.   :7.897e+08   Length:9000055     Length:9000055    
##  1st Qu.:18124   1st Qu.:  648   1st Qu.:3.000   1st Qu.:9.468e+08   Class :character   Class :character  
##  Median :35738   Median : 1834   Median :4.000   Median :1.035e+09   Mode  :character   Mode  :character  
##  Mean   :35870   Mean   : 4122   Mean   :3.512   Mean   :1.033e+09                                        
##  3rd Qu.:53607   3rd Qu.: 3626   3rd Qu.:4.000   3rd Qu.:1.127e+09                                        
##  Max.   :71567   Max.   :65133   Max.   :5.000   Max.   :1.231e+09
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{summary}\NormalTok{(final\_holdout\_test)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##      userId         movieId          rating        timestamp            title              genres         
##  Min.   :    1   Min.   :    1   Min.   :0.500   Min.   :7.897e+08   Length:999999      Length:999999     
##  1st Qu.:18096   1st Qu.:  648   1st Qu.:3.000   1st Qu.:9.467e+08   Class :character   Class :character  
##  Median :35768   Median : 1827   Median :4.000   Median :1.035e+09   Mode  :character   Mode  :character  
##  Mean   :35870   Mean   : 4108   Mean   :3.512   Mean   :1.033e+09                                        
##  3rd Qu.:53621   3rd Qu.: 3624   3rd Qu.:4.000   3rd Qu.:1.127e+09                                        
##  Max.   :71567   Max.   :65133   Max.   :5.000   Max.   :1.231e+09
\end{verbatim}

\paragraph{\texorpdfstring{\texttt{edx}
Dataset}{edx Dataset}}\label{edx-dataset}

\hfill\break
Let's look into the details of the \texttt{edx} dataset:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{str}\NormalTok{(edx)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 'data.frame':    9000055 obs. of  6 variables:
##  $ userId   : int  1 1 1 1 1 1 1 1 1 1 ...
##  $ movieId  : int  122 185 292 316 329 355 356 362 364 370 ...
##  $ rating   : num  5 5 5 5 5 5 5 5 5 5 ...
##  $ timestamp: int  838985046 838983525 838983421 838983392 838983392 838984474 838983653 838984885 838983707 838984596 ...
##  $ title    : chr  "Boomerang (1992)" "Net, The (1995)" "Outbreak (1995)" "Stargate (1994)" ...
##  $ genres   : chr  "Comedy|Romance" "Action|Crime|Thriller" "Action|Drama|Sci-Fi|Thriller" "Action|Adventure|Sci-Fi" ...
\end{verbatim}

Note that we have 9000055 rows and six columns in there:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{dim\_edx }\OtherTok{\textless{}{-}} \FunctionTok{dim}\NormalTok{(edx)}
\FunctionTok{print}\NormalTok{(dim\_edx)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 9000055       6
\end{verbatim}

First, let's note that we have 10677 different movies:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{n\_movies }\OtherTok{\textless{}{-}} \FunctionTok{n\_distinct}\NormalTok{(edx}\SpecialCharTok{$}\NormalTok{movieId)}
\FunctionTok{print}\NormalTok{(n\_movies)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 10677
\end{verbatim}

and 69878 different users in the dataset:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{n\_users }\OtherTok{\textless{}{-}} \FunctionTok{n\_distinct}\NormalTok{(edx}\SpecialCharTok{$}\NormalTok{userId)}
\FunctionTok{print}\NormalTok{(n\_users)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 69878
\end{verbatim}

Now, note the expressions below which confirm the fact explained in
\href{https://rafalab.dfci.harvard.edu/dsbook-part-2/highdim/regularization.html\#movielens-data}{Section
\emph{23.1.1 Movielens data}} of the \emph{Course
Textbook}\autocite{IDS2} that not every user rated every movie:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{max\_possible\_ratings }\OtherTok{\textless{}{-}}\NormalTok{ n\_movies}\SpecialCharTok{*}\NormalTok{n\_users}
\FunctionTok{sprintf}\NormalTok{(}\StringTok{"Maximum possible ratings: \%s"}\NormalTok{, max\_possible\_ratings)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "Maximum possible ratings: 746087406"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sprintf}\NormalTok{(}\StringTok{"Rows in \textasciigrave{}edx\textasciigrave{} dataset: \%s"}\NormalTok{, dim\_edx[}\DecValTok{1}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "Rows in `edx` dataset: 9000055"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sprintf}\NormalTok{(}\StringTok{"Not every movie was rated: \%s"}\NormalTok{, max\_possible\_ratings }\SpecialCharTok{\textgreater{}}\NormalTok{ dim\_edx[}\DecValTok{1}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "Not every movie was rated: TRUE"
\end{verbatim}

As also explained in that section, we can think of these data as a very
large matrix, with users on the rows and movies on the columns, with
many empty cells. Therefore, we can think of a recommendation system as
filling in the \texttt{NA}s in the dataset for the movies that some or
all the users do not rate. A sample from the \texttt{edx} data below
illustrates this idea\autocite{IDS2_23-1-1}:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{keep }\OtherTok{\textless{}{-}}\NormalTok{ edx }\SpecialCharTok{|\textgreater{}} 
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{count}\NormalTok{(movieId) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{top\_n}\NormalTok{(}\DecValTok{4}\NormalTok{, n) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{pull}\NormalTok{(movieId)}

\NormalTok{tab }\OtherTok{\textless{}{-}}\NormalTok{ edx }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{filter}\NormalTok{(movieId }\SpecialCharTok{\%in\%}\NormalTok{ keep) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{filter}\NormalTok{(userId }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\DecValTok{13}\SpecialCharTok{:}\DecValTok{20}\NormalTok{)) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{select}\NormalTok{(userId, title, rating) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{title =} \FunctionTok{str\_remove}\NormalTok{(title, }\StringTok{", The"}\NormalTok{),}
         \AttributeTok{title =} \FunctionTok{str\_remove}\NormalTok{(title, }\StringTok{":.*"}\NormalTok{)) }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{pivot\_wider}\NormalTok{(}\AttributeTok{names\_from =} \StringTok{"title"}\NormalTok{, }\AttributeTok{values\_from =} \StringTok{"rating"}\NormalTok{)}

\FunctionTok{print}\NormalTok{(tab)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A tibble: 5 x 5
##   userId `Pulp Fiction (1994)` `Jurassic Park (1993)` `Silence of the Lambs (1991)` `Forrest Gump (1994)`
##    <int>                 <dbl>                  <dbl>                         <dbl>                 <dbl>
## 1     13                     4                     NA                            NA                    NA
## 2     16                    NA                      3                            NA                    NA
## 3     17                    NA                     NA                             5                    NA
## 4     18                     5                      3                             5                    NA
## 5     19                    NA                      1                            NA                     4
\end{verbatim}

The following plot of the matrix for a random sample of 100 movies and
100 users with yellow indicating a user/movie combination for which we
have a rating shows how \emph{sparse} the matrix is:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{users }\OtherTok{\textless{}{-}} \FunctionTok{sample}\NormalTok{(}\FunctionTok{unique}\NormalTok{(edx}\SpecialCharTok{$}\NormalTok{userId), }\DecValTok{100}\NormalTok{)}

\NormalTok{rafalib}\SpecialCharTok{::}\FunctionTok{mypar}\NormalTok{()}
\NormalTok{edx}\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{filter}\NormalTok{(userId }\SpecialCharTok{\%in\%}\NormalTok{ users) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{select}\NormalTok{(userId, movieId, rating) }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{rating =} \DecValTok{1}\NormalTok{) }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{pivot\_wider}\NormalTok{(}\AttributeTok{names\_from =}\NormalTok{ movieId, }\AttributeTok{values\_from =}\NormalTok{ rating) }\SpecialCharTok{|\textgreater{}} 
\NormalTok{  (\textbackslash{}(mat) mat[, }\FunctionTok{sample}\NormalTok{(}\FunctionTok{ncol}\NormalTok{(mat), }\DecValTok{100}\NormalTok{)])() }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{as.matrix}\NormalTok{() }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{t}\NormalTok{() }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{image}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{100}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{100}\NormalTok{, }\AttributeTok{z =}\NormalTok{ \_ , }\AttributeTok{xlab =} \StringTok{"Movies"}\NormalTok{, }\AttributeTok{ylab =} \StringTok{"Users"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics[width=0.4\linewidth]{capstone-movielens-report.draft4_files/figure-latex/sparsity-of-movie-recs-1}

Further observations highlighted there that, as we can see from the
distributions the author presented, some movies get rated more than
others, and some users are more active than others in rating movies:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{p1 }\OtherTok{\textless{}{-}}\NormalTok{ edx }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{count}\NormalTok{(movieId) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{ggplot}\NormalTok{(}\FunctionTok{aes}\NormalTok{(n)) }\SpecialCharTok{+} 
  \FunctionTok{geom\_histogram}\NormalTok{(}\AttributeTok{bins =} \DecValTok{30}\NormalTok{, }\AttributeTok{color =} \StringTok{"black"}\NormalTok{) }\SpecialCharTok{+} 
  \FunctionTok{scale\_x\_log10}\NormalTok{() }\SpecialCharTok{+} 
  \FunctionTok{ggtitle}\NormalTok{(}\StringTok{"Movies"}\NormalTok{)}

\NormalTok{p2 }\OtherTok{\textless{}{-}}\NormalTok{ edx }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{count}\NormalTok{(userId) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{ggplot}\NormalTok{(}\FunctionTok{aes}\NormalTok{(n)) }\SpecialCharTok{+} 
  \FunctionTok{geom\_histogram}\NormalTok{(}\AttributeTok{bins =} \DecValTok{30}\NormalTok{, }\AttributeTok{color =} \StringTok{"black"}\NormalTok{) }\SpecialCharTok{+} 
  \FunctionTok{scale\_x\_log10}\NormalTok{() }\SpecialCharTok{+} 
  \FunctionTok{ggtitle}\NormalTok{(}\StringTok{"Users"}\NormalTok{)}

\NormalTok{gridExtra}\SpecialCharTok{::}\FunctionTok{grid.arrange}\NormalTok{(p2, p1, }\AttributeTok{ncol =} \DecValTok{2}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{capstone-movielens-report.draft4_files/figure-latex/movie-id-and-user-hists-1.pdf}

Finally, we can see that no movies have a rating of 0. Movies are rated
from 0.5 to 5.0 in 0.5 increments:

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\#library(dplyr)}
\NormalTok{s }\OtherTok{\textless{}{-}}\NormalTok{ edx }\SpecialCharTok{|\textgreater{}} \FunctionTok{group\_by}\NormalTok{(rating) }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{summarise}\NormalTok{(}\AttributeTok{n =} \FunctionTok{n}\NormalTok{())}
\FunctionTok{print}\NormalTok{(s)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A tibble: 10 x 2
##    rating       n
##     <dbl>   <int>
##  1    0.5   85374
##  2    1    345679
##  3    1.5  106426
##  4    2    711422
##  5    2.5  333010
##  6    3   2121240
##  7    3.5  791624
##  8    4   2588430
##  9    4.5  526736
## 10    5   1390114
\end{verbatim}

Further analysis of the \texttt{edx} dataset have been also inspired by
the article mentioned above\autocite{MRS-R-BEST}, from which the code
and explanatory notes below were cited.

\subparagraph{\texorpdfstring{Rating distribution
plot\autocite{MRS-R-BEST}}{Rating distribution plot{[}@MRS-R-BEST{]}}}\label{rating-distribution-plotmrs-r-best}

\hfill\break
The code below demonstrates another way of visualizing the rating
distribution:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{edx }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{group\_by}\NormalTok{(rating) }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{summarize}\NormalTok{(}\AttributeTok{count =} \FunctionTok{n}\NormalTok{()) }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{ggplot}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ rating, }\AttributeTok{y =}\NormalTok{ count)) }\SpecialCharTok{+}
  \FunctionTok{geom\_bar}\NormalTok{(}\AttributeTok{stat =} \StringTok{"identity"}\NormalTok{, }\AttributeTok{fill =} \StringTok{"\#8888ff"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{ggtitle}\NormalTok{(}\StringTok{"Rating Distribution"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{xlab}\NormalTok{(}\StringTok{"Rating"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{ylab}\NormalTok{(}\StringTok{"Occurrences Count"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{scale\_y\_continuous}\NormalTok{(}\AttributeTok{labels =}\NormalTok{ comma) }\SpecialCharTok{+}
  \FunctionTok{scale\_x\_continuous}\NormalTok{(}\AttributeTok{n.breaks =} \DecValTok{10}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_economist}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}\AttributeTok{axis.title.x =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{vjust =} \SpecialCharTok{{-}}\DecValTok{5}\NormalTok{, }\AttributeTok{face =} \StringTok{"bold"}\NormalTok{), }
        \AttributeTok{axis.title.y =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{vjust =} \DecValTok{10}\NormalTok{, }\AttributeTok{face =} \StringTok{"bold"}\NormalTok{), }
        \AttributeTok{plot.margin =} \FunctionTok{margin}\NormalTok{(}\FloatTok{0.7}\NormalTok{, }\FloatTok{0.5}\NormalTok{, }\DecValTok{1}\NormalTok{, }\FloatTok{1.2}\NormalTok{, }\StringTok{"cm"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\includegraphics{capstone-movielens-report.draft4_files/figure-latex/unnamed-chunk-11-1.pdf}

This graph is another confirmation of what we found out above: rounded
ratings occur more often than half-stared ones. The upward trend
previously discussed is now perfectly clear, although it seems to top
right between the 3 and 4-star ratings lowering the occurrences count
afterward. That might be due to users being more hesitant to rate with
the highest mark for whichever reasons they might
hold\autocite{MRS-R-BEST}.

\subparagraph{Ratings per movie}\label{ratings-per-movie}

\hfill\break

Movie popularity count\autocite{MRS-R-BEST}

\hfill\break

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{print}\NormalTok{(edx }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{group\_by}\NormalTok{(movieId) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{summarize}\NormalTok{(}\AttributeTok{count =} \FunctionTok{n}\NormalTok{()) }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{slice\_head}\NormalTok{(}\AttributeTok{n =} \DecValTok{10}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A tibble: 10 x 2
##    movieId count
##      <int> <int>
##  1       1 23790
##  2       2 10779
##  3       3  7028
##  4       4  1577
##  5       5  6400
##  6       6 12346
##  7       7  7259
##  8       8   821
##  9       9  2278
## 10      10 15187
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{summary}\NormalTok{(edx }\SpecialCharTok{|\textgreater{}} \FunctionTok{group\_by}\NormalTok{(movieId) }\SpecialCharTok{|\textgreater{}} \FunctionTok{summarize}\NormalTok{(}\AttributeTok{count =} \FunctionTok{n}\NormalTok{()) }\SpecialCharTok{|\textgreater{}} \FunctionTok{select}\NormalTok{(count))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##      count        
##  Min.   :    1.0  
##  1st Qu.:   30.0  
##  Median :  122.0  
##  Mean   :  842.9  
##  3rd Qu.:  565.0  
##  Max.   :31362.0
\end{verbatim}

Ratings per movie plot\autocite{MRS-R-BEST}

\hfill\break

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{edx }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{group\_by}\NormalTok{(movieId) }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{summarize}\NormalTok{(}\AttributeTok{count =} \FunctionTok{n}\NormalTok{()) }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{ggplot}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ movieId, }\AttributeTok{y =}\NormalTok{ count)) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{(}\AttributeTok{alpha =} \FloatTok{0.2}\NormalTok{, }\AttributeTok{color =} \StringTok{"\#4020dd"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_smooth}\NormalTok{(}\AttributeTok{color =} \StringTok{"red"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{ggtitle}\NormalTok{(}\StringTok{"Ratings per movie"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{xlab}\NormalTok{(}\StringTok{"Movies"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{ylab}\NormalTok{(}\StringTok{"Number of ratings"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{scale\_y\_continuous}\NormalTok{(}\AttributeTok{labels =}\NormalTok{ comma) }\SpecialCharTok{+}
  \FunctionTok{scale\_x\_continuous}\NormalTok{(}\AttributeTok{n.breaks =} \DecValTok{10}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_economist}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}\AttributeTok{axis.title.x =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{vjust =} \SpecialCharTok{{-}}\DecValTok{5}\NormalTok{, }\AttributeTok{face =} \StringTok{"bold"}\NormalTok{), }
        \AttributeTok{axis.title.y =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{vjust =} \DecValTok{10}\NormalTok{, }\AttributeTok{face =} \StringTok{"bold"}\NormalTok{), }
        \AttributeTok{plot.margin =} \FunctionTok{margin}\NormalTok{(}\FloatTok{0.7}\NormalTok{, }\FloatTok{0.5}\NormalTok{, }\DecValTok{1}\NormalTok{, }\FloatTok{1.2}\NormalTok{, }\StringTok{"cm"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## `geom_smooth()` using method = 'gam' and formula = 'y ~ s(x, bs = "cs")'
\end{verbatim}

\includegraphics{capstone-movielens-report.draft4_files/figure-latex/unnamed-chunk-14-1.pdf}

Movies' rating histogram\autocite{MRS-R-BEST}

\hfill\break

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{edx }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{group\_by}\NormalTok{(movieId) }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{summarize}\NormalTok{(}\AttributeTok{count =} \FunctionTok{n}\NormalTok{()) }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{ggplot}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ count)) }\SpecialCharTok{+}
  \FunctionTok{geom\_histogram}\NormalTok{(}\AttributeTok{fill =} \StringTok{"\#8888ff"}\NormalTok{, }\AttributeTok{color =} \StringTok{"\#4020dd"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{ggtitle}\NormalTok{(}\StringTok{"Movies\textquotesingle{} rating histogram"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{xlab}\NormalTok{(}\StringTok{"Rating count"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{ylab}\NormalTok{(}\StringTok{"Number of movies"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{scale\_y\_continuous}\NormalTok{(}\AttributeTok{labels =}\NormalTok{ comma) }\SpecialCharTok{+}
  \FunctionTok{scale\_x\_log10}\NormalTok{(}\AttributeTok{n.breaks =} \DecValTok{10}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_economist}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}\AttributeTok{axis.title.x =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{vjust =} \SpecialCharTok{{-}}\DecValTok{5}\NormalTok{, }\AttributeTok{face =} \StringTok{"bold"}\NormalTok{), }
        \AttributeTok{axis.title.y =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{vjust =} \DecValTok{10}\NormalTok{, }\AttributeTok{face =} \StringTok{"bold"}\NormalTok{), }
        \AttributeTok{plot.margin =} \FunctionTok{margin}\NormalTok{(}\FloatTok{0.7}\NormalTok{, }\FloatTok{0.5}\NormalTok{, }\DecValTok{1}\NormalTok{, }\FloatTok{1.2}\NormalTok{, }\StringTok{"cm"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.
\end{verbatim}

\includegraphics{capstone-movielens-report.draft4_files/figure-latex/unnamed-chunk-15-1.pdf}

\subparagraph{\texorpdfstring{Ratings per
user\autocite{MRS-R-BEST}}{Ratings per user{[}@MRS-R-BEST{]}}}\label{ratings-per-usermrs-r-best}

\hfill\break

User rating count (activity measure)

\hfill\break

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{print}\NormalTok{(edx }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{group\_by}\NormalTok{(userId) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{summarize}\NormalTok{(}\AttributeTok{count =} \FunctionTok{n}\NormalTok{()) }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{slice\_head}\NormalTok{(}\AttributeTok{n =} \DecValTok{10}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A tibble: 10 x 2
##    userId count
##     <int> <int>
##  1      1    19
##  2      2    17
##  3      3    31
##  4      4    35
##  5      5    74
##  6      6    39
##  7      7    96
##  8      8   727
##  9      9    21
## 10     10   112
\end{verbatim}

User rating summary

\hfill\break

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{summary}\NormalTok{(edx }\SpecialCharTok{|\textgreater{}} \FunctionTok{group\_by}\NormalTok{(userId) }\SpecialCharTok{|\textgreater{}} \FunctionTok{summarize}\NormalTok{(}\AttributeTok{count =} \FunctionTok{n}\NormalTok{()) }\SpecialCharTok{|\textgreater{}} \FunctionTok{select}\NormalTok{(count))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##      count       
##  Min.   :  10.0  
##  1st Qu.:  32.0  
##  Median :  62.0  
##  Mean   : 128.8  
##  3rd Qu.: 141.0  
##  Max.   :6616.0
\end{verbatim}

Ratings per user plot

\hfill\break

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{edx }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{group\_by}\NormalTok{(userId) }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{summarize}\NormalTok{(}\AttributeTok{count =} \FunctionTok{n}\NormalTok{()) }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{ggplot}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ userId, }\AttributeTok{y =}\NormalTok{ count)) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{(}\AttributeTok{alpha =} \FloatTok{0.2}\NormalTok{, }\AttributeTok{color =} \StringTok{"\#4020dd"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_smooth}\NormalTok{(}\AttributeTok{color =} \StringTok{"red"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{ggtitle}\NormalTok{(}\StringTok{"Ratings per user"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{xlab}\NormalTok{(}\StringTok{"Users"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{ylab}\NormalTok{(}\StringTok{"Number of ratings"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{scale\_y\_continuous}\NormalTok{(}\AttributeTok{labels =}\NormalTok{ comma) }\SpecialCharTok{+}
  \FunctionTok{scale\_x\_continuous}\NormalTok{(}\AttributeTok{n.breaks =} \DecValTok{10}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_economist}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}\AttributeTok{axis.title.x =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{vjust =} \SpecialCharTok{{-}}\DecValTok{5}\NormalTok{, }\AttributeTok{face =} \StringTok{"bold"}\NormalTok{), }
        \AttributeTok{axis.title.y =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{vjust =} \DecValTok{10}\NormalTok{, }\AttributeTok{face =} \StringTok{"bold"}\NormalTok{), }
        \AttributeTok{plot.margin =} \FunctionTok{margin}\NormalTok{(}\FloatTok{0.7}\NormalTok{, }\FloatTok{0.5}\NormalTok{, }\DecValTok{1}\NormalTok{, }\FloatTok{1.2}\NormalTok{, }\StringTok{"cm"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## `geom_smooth()` using method = 'gam' and formula = 'y ~ s(x, bs = "cs")'
\end{verbatim}

\includegraphics{capstone-movielens-report.draft4_files/figure-latex/unnamed-chunk-18-1.pdf}

Users' rating histogram

\hfill\break

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{edx }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{group\_by}\NormalTok{(userId) }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{summarize}\NormalTok{(}\AttributeTok{count =} \FunctionTok{n}\NormalTok{()) }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{ggplot}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ count)) }\SpecialCharTok{+}
  \FunctionTok{geom\_histogram}\NormalTok{(}\AttributeTok{fill =} \StringTok{"\#8888ff"}\NormalTok{, }\AttributeTok{color =} \StringTok{"\#4020dd"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{ggtitle}\NormalTok{(}\StringTok{"Users\textquotesingle{} rating histogram"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{xlab}\NormalTok{(}\StringTok{"Rating count"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{ylab}\NormalTok{(}\StringTok{"Number of users"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{scale\_y\_continuous}\NormalTok{(}\AttributeTok{labels =}\NormalTok{ comma) }\SpecialCharTok{+}
  \FunctionTok{scale\_x\_log10}\NormalTok{(}\AttributeTok{n.breaks =} \DecValTok{10}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_economist}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}\AttributeTok{axis.title.x =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{vjust =} \SpecialCharTok{{-}}\DecValTok{5}\NormalTok{, }\AttributeTok{face =} \StringTok{"bold"}\NormalTok{), }
        \AttributeTok{axis.title.y =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{vjust =} \DecValTok{10}\NormalTok{, }\AttributeTok{face =} \StringTok{"bold"}\NormalTok{), }
        \AttributeTok{plot.margin =} \FunctionTok{margin}\NormalTok{(}\FloatTok{0.7}\NormalTok{, }\FloatTok{0.5}\NormalTok{, }\DecValTok{1}\NormalTok{, }\FloatTok{1.2}\NormalTok{, }\StringTok{"cm"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.
\end{verbatim}

\includegraphics{capstone-movielens-report.draft4_files/figure-latex/unnamed-chunk-19-1.pdf}

\subsection{Methods / Analysis}\label{methods-analysis}

\begin{noteblock}
All the source code of the R-scripts is available on the project's
\href{https://github.com/AzKurban-edX-DS/Capstone-MovieLens/tree/main/r/src}{GitHub
repository}\autocite{edx_capstone_movielens}.

\end{noteblock}

\subsubsection{Defining Logging and Mesuring helper
functions}\label{defining-logging-and-mesuring-helper-functions}

\hfill\break

First, let's define some helper functions for logging and time-measuring
features that we will use in our R scripts. Some of them are listed
below:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{open\_logfile }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(file\_name)\{}
\NormalTok{  log\_file\_name }\OtherTok{\textless{}{-}} \FunctionTok{as.character}\NormalTok{(}\FunctionTok{Sys.time}\NormalTok{()) }\SpecialCharTok{|\textgreater{}} 
    \FunctionTok{str\_replace\_all}\NormalTok{(}\StringTok{\textquotesingle{}:\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}\_\textquotesingle{}}\NormalTok{) }\SpecialCharTok{|\textgreater{}} 
    \FunctionTok{str\_replace}\NormalTok{(}\StringTok{\textquotesingle{} \textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}T\textquotesingle{}}\NormalTok{) }\SpecialCharTok{|\textgreater{}}
    \FunctionTok{str\_c}\NormalTok{(file\_name)}
  
  \FunctionTok{log\_open}\NormalTok{(}\AttributeTok{file\_name =}\NormalTok{ log\_file\_name)}
\NormalTok{\}}
\NormalTok{print\_start\_date }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{()\{}
  \FunctionTok{print}\NormalTok{(}\FunctionTok{date}\NormalTok{())}
  \FunctionTok{Sys.time}\NormalTok{()}
\NormalTok{\}}
\NormalTok{put\_start\_date }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{()\{}
  \FunctionTok{put}\NormalTok{(}\FunctionTok{date}\NormalTok{())}
  \FunctionTok{Sys.time}\NormalTok{()}
\NormalTok{\}}
\NormalTok{print\_end\_date }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(start)\{}
  \FunctionTok{print}\NormalTok{(}\FunctionTok{date}\NormalTok{())}
  \FunctionTok{print}\NormalTok{(}\FunctionTok{Sys.time}\NormalTok{() }\SpecialCharTok{{-}}\NormalTok{ start)}
\NormalTok{\}}
\NormalTok{put\_end\_date }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(start)\{}
  \FunctionTok{put}\NormalTok{(}\FunctionTok{date}\NormalTok{())}
  \FunctionTok{put}\NormalTok{(}\FunctionTok{Sys.time}\NormalTok{() }\SpecialCharTok{{-}}\NormalTok{ start)}
\NormalTok{\}}

\NormalTok{print\_log }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(msg)\{}
  \FunctionTok{print}\NormalTok{(}\FunctionTok{str\_glue}\NormalTok{(msg))}
\NormalTok{\}}
\NormalTok{put\_log }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(msg)\{}
  \FunctionTok{put}\NormalTok{(}\FunctionTok{str\_glue}\NormalTok{(msg))}
\NormalTok{\}}
\NormalTok{put\_log1 }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(msg\_template, arg1)\{}
\NormalTok{  msg }\OtherTok{\textless{}{-}} \FunctionTok{str\_replace\_all}\NormalTok{(msg\_template, }\StringTok{"\%1"}\NormalTok{, }\FunctionTok{as.character}\NormalTok{(arg1))}
  \FunctionTok{put}\NormalTok{(}\FunctionTok{str\_glue}\NormalTok{(msg))}
\NormalTok{\}}
\NormalTok{put\_log2 }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(msg\_template, arg1, arg2)\{}
\NormalTok{  msg }\OtherTok{\textless{}{-}}\NormalTok{ msg\_template }\SpecialCharTok{|\textgreater{}} 
    \FunctionTok{str\_replace\_all}\NormalTok{(}\StringTok{"\%1"}\NormalTok{, }\FunctionTok{as.character}\NormalTok{(arg1)) }\SpecialCharTok{|\textgreater{}}
    \FunctionTok{str\_replace\_all}\NormalTok{(}\StringTok{"\%2"}\NormalTok{, }\FunctionTok{as.character}\NormalTok{(arg2)) }\SpecialCharTok{|\textgreater{}}
    \FunctionTok{str\_glue}\NormalTok{()}
  
  \FunctionTok{put}\NormalTok{(msg)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\begin{noteblock}
The full source code of these functions is available in the
\href{https://github.com/AzKurban-edX-DS/Capstone-MovieLens/blob/2c5d96ac98a8b8fa4151aa8295f91ac29d9472b3/r/src/capstone-movielens.main.R\#L1}{Logging
Helper function section of the Capstone MovieLens Main R Script}.

\end{noteblock}

\subsubsection{Preparing train and set
datasets}\label{preparing-train-and-set-datasets}

\hfill\break

We will split the \texttt{edx} dataset into a training set, which we
will use to build and train our models, and a test set in which we will
compute the accuracy of our predictions, the way described in
\href{https://rafalab.dfci.harvard.edu/dsbook-part-2/highdim/regularization.html\#movielens-data}{Section
23.1.1 Movielens data} of the \emph{Course Textbook} mentioned
above\autocite{IDS2_23-1-1}.We will also use the \emph{5-Fold Cross
Validation} method as described in
\href{https://rafalab.dfci.harvard.edu/dsbook-part-2/ml/resampling-methods.html\#cross-validation}{Section
29.6 Cross validation} of the \emph{Course Textbook}. To prepare
datasets for processing, we will use the following functions,
specifically designed for these operations:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{make\_source\_datasets}\NormalTok{()}
\FunctionTok{init\_source\_datasets}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{noteblock}
The full source code of the function listed above is available in the
\href{https://github.com/AzKurban-edX-DS/Capstone-MovieLens/blob/2c5d96ac98a8b8fa4151aa8295f91ac29d9472b3/r/src/support-functions/data.helper.functions.R\#L86}{\texttt{Initialize\ input\ datasets}
section of the \texttt{data.helper.functions.R} script on \emph{GitHub}}

\end{noteblock}

\paragraph{\texorpdfstring{The \texttt{make\_source\_datasets}
function}{The make\_source\_datasets function}}\label{the-make_source_datasets-function}

\hfill\break

Let's take a closer look at the objects we will receive as a result of
executing this function.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{make\_source\_datasets }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{()\{}
  \CommentTok{\# ...}
  \FunctionTok{list}\NormalTok{(}\AttributeTok{edx\_CV =}\NormalTok{ edx\_CV,}
       \AttributeTok{edx.mx =}\NormalTok{ edx.mx,}
       \AttributeTok{edx.sgr =}\NormalTok{ edx.sgr,}
       \AttributeTok{tuning\_sets =}\NormalTok{ tuning\_sets,}
       \AttributeTok{movie\_map =}\NormalTok{ movie\_map,}
       \AttributeTok{date\_days\_map =}\NormalTok{ date\_days\_map)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\subparagraph{\texorpdfstring{\texttt{edx.mx} Matrix
Object}{edx.mx Matrix Object}}\label{edx.mx-matrix-object}

\hfill\break

We will use the array representation described in
\href{https://rafalab.dfci.harvard.edu/dsbook-part-2/linear-models/treatment-effect-models.html\#sec-anova}{Section
17.5 of the Textbook}, for the training data: we denote ranking for
movie \(j\) by user \(i\) as \(y_{i,j}\). To create this matrix, we use
\texttt{tidyr::pivot\_wider} function:

\begin{Shaded}
\begin{Highlighting}[]
  \FunctionTok{put\_log}\NormalTok{(}\StringTok{"Function: \textasciigrave{}make\_source\_datasets\textasciigrave{}: Creating Rating Matrix from \textasciigrave{}edx\textasciigrave{} dataset..."}\NormalTok{)}
\NormalTok{  edx.mx }\OtherTok{\textless{}{-}}\NormalTok{ edx }\SpecialCharTok{|\textgreater{}} 
    \FunctionTok{mutate}\NormalTok{(}\AttributeTok{userId =} \FunctionTok{factor}\NormalTok{(userId),}
           \AttributeTok{movieId =} \FunctionTok{factor}\NormalTok{(movieId)) }\SpecialCharTok{|\textgreater{}}
    \FunctionTok{select}\NormalTok{(movieId, userId, rating) }\SpecialCharTok{|\textgreater{}}
    \FunctionTok{pivot\_wider}\NormalTok{(}\AttributeTok{names\_from =}\NormalTok{ movieId, }\AttributeTok{values\_from =}\NormalTok{ rating) }\SpecialCharTok{|\textgreater{}}
    \FunctionTok{column\_to\_rownames}\NormalTok{(}\StringTok{"userId"}\NormalTok{) }\SpecialCharTok{|\textgreater{}}
    \FunctionTok{as.matrix}\NormalTok{()}
  
  \FunctionTok{put\_log}\NormalTok{(}\StringTok{"Function: \textasciigrave{}make\_source\_datasets\textasciigrave{}:}
\StringTok{Matrix created: \textasciigrave{}edx.mx\textasciigrave{} of the following dimentions:"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
  \FunctionTok{str}\NormalTok{(edx.mx)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  num [1:69878, 1:10677] 5 NA NA NA NA NA NA NA NA NA ...
##  - attr(*, "dimnames")=List of 2
##   ..$ : chr [1:69878] "1" "2" "3" "4" ...
##   ..$ : chr [1:10677] "122" "185" "292" "316" ...
\end{verbatim}

\subparagraph{\texorpdfstring{\texttt{edx.sgr}
Object}{edx.sgr Object}}\label{edx.sgr-object}

\hfill\break

To account for the Movie Genre Effect more accurately, we need a dataset
with split rows for movies belonging to multiple genres:

\begin{Shaded}
\begin{Highlighting}[]
  \FunctionTok{put\_log}\NormalTok{(}\StringTok{"Function: \textasciigrave{}make\_source\_datasets\textasciigrave{}: }
\StringTok{To account for the Movie Genre Effect, we need a dataset with split rows }
\StringTok{for movies belonging to multiple genres."}\NormalTok{)}
\NormalTok{  edx.sgr }\OtherTok{\textless{}{-}} \FunctionTok{splitGenreRows}\NormalTok{(edx)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{str}\NormalTok{(edx.sgr)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## tibble [23,371,423 x 6] (S3: tbl_df/tbl/data.frame)
##  $ userId   : int [1:23371423] 1 1 1 1 1 1 1 1 1 1 ...
##  $ movieId  : int [1:23371423] 122 122 185 185 185 292 292 292 292 316 ...
##  $ rating   : num [1:23371423] 5 5 5 5 5 5 5 5 5 5 ...
##  $ timestamp: int [1:23371423] 838985046 838985046 838983525 838983525 838983525 838983421 838983421 838983421 838983421 838983392 ...
##  $ title    : chr [1:23371423] "Boomerang (1992)" "Boomerang (1992)" "Net, The (1995)" "Net, The (1995)" ...
##  $ genres   : chr [1:23371423] "Comedy" "Romance" "Action" "Crime" ...
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{summary}\NormalTok{(edx.sgr)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##      userId         movieId          rating        timestamp            title              genres         
##  Min.   :    1   Min.   :    1   Min.   :0.500   Min.   :7.897e+08   Length:23371423    Length:23371423   
##  1st Qu.:18140   1st Qu.:  616   1st Qu.:3.000   1st Qu.:9.472e+08   Class :character   Class :character  
##  Median :35784   Median : 1748   Median :4.000   Median :1.042e+09   Mode  :character   Mode  :character  
##  Mean   :35886   Mean   : 4277   Mean   :3.527   Mean   :1.035e+09                                        
##  3rd Qu.:53638   3rd Qu.: 3635   3rd Qu.:4.000   3rd Qu.:1.131e+09                                        
##  Max.   :71567   Max.   :65133   Max.   :5.000   Max.   :1.231e+09
\end{verbatim}

Note that we use the \texttt{splitGenreRows} function to split rows of
the original dataset:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{splitGenreRows }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(data)\{}
  \FunctionTok{put}\NormalTok{(}\StringTok{"Splitting dataset rows related to multiple genres..."}\NormalTok{)}
\NormalTok{  start }\OtherTok{\textless{}{-}} \FunctionTok{put\_start\_date}\NormalTok{()}
\NormalTok{  gs\_splitted }\OtherTok{\textless{}{-}}\NormalTok{ data }\SpecialCharTok{|\textgreater{}}
    \FunctionTok{separate\_rows}\NormalTok{(genres, }\AttributeTok{sep =} \StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{|"}\NormalTok{)}
  \FunctionTok{put}\NormalTok{(}\StringTok{"Dataset rows related to multiple genres have been splitted to have single genre per row."}\NormalTok{)}
  \FunctionTok{put\_end\_date}\NormalTok{(start)}
\NormalTok{  gs\_splitted}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\begin{noteblock}
The source code of the function mentioned above is also available in the
\href{https://github.com/AzKurban-edX-DS/Capstone-MovieLens/blob/2c5d96ac98a8b8fa4151aa8295f91ac29d9472b3/r/src/support-functions/data.helper.functions.R\#L86}{\texttt{Initialize\ input\ datasets}
section of the \texttt{data.helper.functions.R} script on \emph{GitHub}}

\end{noteblock}

\subparagraph{\texorpdfstring{\texttt{movie\_map}
Object}{movie\_map Object}}\label{movie_map-object}

\hfill\break

To be able to map movie IDs to titles we create the following lookup
table:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{movie\_map }\OtherTok{\textless{}{-}}\NormalTok{ edx }\SpecialCharTok{|\textgreater{}} \FunctionTok{select}\NormalTok{(movieId, title, genres) }\SpecialCharTok{|\textgreater{}} 
    \FunctionTok{distinct}\NormalTok{(movieId, }\AttributeTok{.keep\_all =} \ConstantTok{TRUE}\NormalTok{)}
  
  \FunctionTok{put\_log}\NormalTok{(}\StringTok{"Function: \textasciigrave{}make\_source\_datasets\textasciigrave{}: Dataset created: movie\_map"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{str}\NormalTok{(movie\_map)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 'data.frame':    10677 obs. of  3 variables:
##  $ movieId: int  122 185 292 316 329 355 356 362 364 370 ...
##  $ title  : chr  "Boomerang (1992)" "Net, The (1995)" "Outbreak (1995)" "Stargate (1994)" ...
##  $ genres : chr  "Comedy|Romance" "Action|Crime|Thriller" "Action|Drama|Sci-Fi|Thriller" "Action|Adventure|Sci-Fi" ...
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{summary}\NormalTok{(movie\_map)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     movieId         title              genres         
##  Min.   :    1   Length:10677       Length:10677      
##  1st Qu.: 2754   Class :character   Class :character  
##  Median : 5434   Mode  :character   Mode  :character  
##  Mean   :13105                                        
##  3rd Qu.: 8710                                        
##  Max.   :65133
\end{verbatim}

Note that titles cannot be considered unique, so we can't use them as
IDs\autocite{IDS2_23-1-1}.

\subparagraph{\texorpdfstring{\texttt{date\_days\_map}
Object}{date\_days\_map Object}}\label{date_days_map-object}

\hfill\break

We have a \texttt{timestamp} field in the \texttt{edx} dataset. To be
able to map the date, year, and number of days since the earliest record
in the \texttt{edx} dataset with the corresponding value in this field,
we create the following lookup table:

\begin{Shaded}
\begin{Highlighting}[]
  \FunctionTok{put\_log}\NormalTok{(}\StringTok{"Function: \textasciigrave{}make\_source\_datasets\textasciigrave{}: Creating Date{-}Days Map dataset..."}\NormalTok{)}
\NormalTok{  date\_days\_map }\OtherTok{\textless{}{-}}\NormalTok{ edx }\SpecialCharTok{|\textgreater{}}
    \FunctionTok{mutate}\NormalTok{(}\AttributeTok{date\_time =} \FunctionTok{as\_datetime}\NormalTok{(timestamp)) }\SpecialCharTok{|\textgreater{}}
    \FunctionTok{mutate}\NormalTok{(}\AttributeTok{date =} \FunctionTok{as\_date}\NormalTok{(date\_time)) }\SpecialCharTok{|\textgreater{}}
    \FunctionTok{mutate}\NormalTok{(}\AttributeTok{year =} \FunctionTok{year}\NormalTok{(date\_time)) }\SpecialCharTok{|\textgreater{}}
    \FunctionTok{mutate}\NormalTok{(}\AttributeTok{days =} \FunctionTok{as.integer}\NormalTok{(date }\SpecialCharTok{{-}} \FunctionTok{min}\NormalTok{(date))) }\SpecialCharTok{|\textgreater{}}
    \FunctionTok{select}\NormalTok{(timestamp, date\_time, date, year, days) }\SpecialCharTok{|\textgreater{}}
    \FunctionTok{distinct}\NormalTok{(timestamp, }\AttributeTok{.keep\_all =} \ConstantTok{TRUE}\NormalTok{)}
  
  \FunctionTok{put\_log}\NormalTok{(}\StringTok{"Function: \textasciigrave{}make\_source\_datasets\textasciigrave{}: Dataset created: date\_days\_map"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
  \FunctionTok{str}\NormalTok{(date\_days\_map)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 'data.frame':    6519590 obs. of  5 variables:
##  $ timestamp: int  838985046 838983525 838983421 838983392 838984474 838983653 838984885 838983707 838984596 838983834 ...
##  $ date_time: POSIXct, format: "1996-08-02 11:24:06" "1996-08-02 10:58:45" "1996-08-02 10:57:01" "1996-08-02 10:56:32" ...
##  $ date     : Date, format: "1996-08-02" "1996-08-02" "1996-08-02" "1996-08-02" ...
##  $ year     : num  1996 1996 1996 1996 1996 ...
##  $ days     : int  571 571 571 571 571 571 571 571 571 571 ...
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
  \FunctionTok{summary}\NormalTok{(date\_days\_map)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    timestamp           date_time                           date                 year           days     
##  Min.   :7.897e+08   Min.   :1995-01-09 11:46:49.00   Min.   :1995-01-09   Min.   :1995   Min.   :   0  
##  1st Qu.:9.783e+08   1st Qu.:2001-01-01 05:05:01.75   1st Qu.:2001-01-01   1st Qu.:2001   1st Qu.:2184  
##  Median :1.091e+09   Median :2004-08-03 01:08:18.50   Median :2004-08-03   Median :2004   Median :3494  
##  Mean   :1.066e+09   Mean   :2003-10-10 23:15:02.07   Mean   :2003-10-10   Mean   :2003   Mean   :3196  
##  3rd Qu.:1.152e+09   3rd Qu.:2006-07-04 20:41:57.50   3rd Qu.:2006-07-04   3rd Qu.:2006   3rd Qu.:4194  
##  Max.   :1.231e+09   Max.   :2009-01-05 05:02:16.00   Max.   :2009-01-05   Max.   :2009   Max.   :5110
\end{verbatim}

\subparagraph{\texorpdfstring{\texttt{edx\_CV}
Object}{edx\_CV Object}}\label{edx_cv-object}

\hfill\break

Here we have a list of sample objects we need to perform the
\emph{5-Fold Cross Validation} as explained in
\href{https://rafalab.dfci.harvard.edu/dsbook-part-2/ml/resampling-methods.html\#k-fold-cross-validation}{Section
29.6.1 K-fold cross validation} of the \emph{Course Textbook}:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{  start }\OtherTok{\textless{}{-}} \FunctionTok{put\_start\_date}\NormalTok{()}
\NormalTok{  edx\_CV }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(kfold\_index,  }\ControlFlowTok{function}\NormalTok{(fold\_i)\{}
    
    \FunctionTok{put\_log1}\NormalTok{(}\StringTok{"Method \textasciigrave{}make\_source\_datasets\textasciigrave{}: }
\StringTok{Creating K{-}Fold Cross Validation Datasets, Fold \%1"}\NormalTok{, fold\_i)}
    
    \CommentTok{\#\textgreater{} We split the initial datasets into training sets, which we will use to build }
    \CommentTok{\#\textgreater{} and train our models, and validation sets in which we will compute the accuracy }
    \CommentTok{\#\textgreater{} of our predictions, the way described in the \textasciigrave{}Section 23.1.1 Movielens data\textasciigrave{}}
    \CommentTok{\#\textgreater{} (https://rafalab.dfci.harvard.edu/dsbook{-}part{-}2/highdim/regularization.html\#movielens{-}data) }
    \CommentTok{\#\textgreater{} of the Course Textbook.}
    
\NormalTok{    split\_sets }\OtherTok{\textless{}{-}}\NormalTok{ edx }\SpecialCharTok{|\textgreater{}}
      \FunctionTok{sample\_train\_validation\_sets}\NormalTok{(fold\_i}\SpecialCharTok{*}\DecValTok{1000}\NormalTok{)}
    
\NormalTok{    train\_set }\OtherTok{\textless{}{-}}\NormalTok{ split\_sets}\SpecialCharTok{$}\NormalTok{train\_set}
\NormalTok{    validation\_set }\OtherTok{\textless{}{-}}\NormalTok{ split\_sets}\SpecialCharTok{$}\NormalTok{validation\_set}
    
    \FunctionTok{put\_log}\NormalTok{(}\StringTok{"Function: \textasciigrave{}make\_source\_datasets\textasciigrave{}: }
\StringTok{Sampling 20\% from the split{-}row version of the \textasciigrave{}edx\textasciigrave{} dataset..."}\NormalTok{)}
\NormalTok{    split\_sets.gs }\OtherTok{\textless{}{-}}\NormalTok{ edx.sgr }\SpecialCharTok{|\textgreater{}}
      \FunctionTok{sample\_train\_validation\_sets}\NormalTok{(fold\_i}\SpecialCharTok{*}\DecValTok{2000}\NormalTok{)}

\NormalTok{    train.sgr }\OtherTok{\textless{}{-}}\NormalTok{ split\_sets.gs}\SpecialCharTok{$}\NormalTok{train\_set}
\NormalTok{    validation.sgr }\OtherTok{\textless{}{-}}\NormalTok{ split\_sets.gs}\SpecialCharTok{$}\NormalTok{validation\_set}
    
    \CommentTok{\# put\_log("Function: \textasciigrave{}make\_source\_datasets\textasciigrave{}: Dataset created: validation.sgr")}
    \CommentTok{\# put(summary(validation.sgr))}
    
    \CommentTok{\#\textgreater{} We will use the array representation described in \textasciigrave{}Section 17.5 of the Textbook\textasciigrave{}}
    \CommentTok{\#\textgreater{} (https://rafalab.dfci.harvard.edu/dsbook{-}part{-}2/linear{-}models/treatment{-}effect{-}models.html\#sec{-}anova), }
    \CommentTok{\#\textgreater{} for the training data. }
    \CommentTok{\#\textgreater{} To create this matrix, we use \textasciigrave{}tidyr::pivot\_wider\textasciigrave{} function:}
    
    \FunctionTok{put\_log}\NormalTok{(}\StringTok{"Function: \textasciigrave{}make\_source\_datasets\textasciigrave{}: Creating Rating Matrix from Train Set..."}\NormalTok{)}
\NormalTok{    train\_mx }\OtherTok{\textless{}{-}}\NormalTok{ train\_set }\SpecialCharTok{|\textgreater{}} 
      \FunctionTok{mutate}\NormalTok{(}\AttributeTok{userId =} \FunctionTok{factor}\NormalTok{(userId),}
             \AttributeTok{movieId =} \FunctionTok{factor}\NormalTok{(movieId)) }\SpecialCharTok{|\textgreater{}}
      \FunctionTok{select}\NormalTok{(movieId, userId, rating) }\SpecialCharTok{|\textgreater{}}
      \FunctionTok{pivot\_wider}\NormalTok{(}\AttributeTok{names\_from =}\NormalTok{ movieId, }\AttributeTok{values\_from =}\NormalTok{ rating) }\SpecialCharTok{|\textgreater{}}
      \FunctionTok{column\_to\_rownames}\NormalTok{(}\StringTok{"userId"}\NormalTok{) }\SpecialCharTok{|\textgreater{}}
      \FunctionTok{as.matrix}\NormalTok{()}
    
    \FunctionTok{put\_log}\NormalTok{(}\StringTok{"Function: \textasciigrave{}make\_source\_datasets\textasciigrave{}:}
\StringTok{Matrix created: \textasciigrave{}train\_mx\textasciigrave{} of the following dimentions:"}\NormalTok{)}
    \FunctionTok{put}\NormalTok{(}\FunctionTok{dim}\NormalTok{(train\_mx))}

    \FunctionTok{list}\NormalTok{(}\AttributeTok{train\_set =}\NormalTok{ train\_set,}
         \AttributeTok{train\_mx =}\NormalTok{ train\_mx,}
         \AttributeTok{train.sgr =}\NormalTok{ train.sgr,}
         \AttributeTok{validation\_set =}\NormalTok{ validation\_set)}
\NormalTok{  \})}
  \FunctionTok{put\_end\_date}\NormalTok{(start)}
  \FunctionTok{put\_log}\NormalTok{(}\StringTok{"Function: \textasciigrave{}make\_source\_datasets\textasciigrave{}: }
\StringTok{Set of K{-}Fold Cross Validation datasets created: edx\_CV"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{str}\NormalTok{(edx\_CV)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## List of 5
##  $ :List of 4
##   ..$ train_set     :'data.frame':   7172311 obs. of  6 variables:
##   .. ..$ userId   : int [1:7172311] 1 1 1 1 1 1 1 1 1 1 ...
##   .. ..$ movieId  : int [1:7172311] 122 185 292 329 356 362 364 370 420 466 ...
##   .. ..$ rating   : num [1:7172311] 5 5 5 5 5 5 5 5 5 5 ...
##   .. ..$ timestamp: int [1:7172311] 838985046 838983525 838983421 838983392 838983653 838984885 838983707 838984596 838983834 838984679 ...
##   .. ..$ title    : chr [1:7172311] "Boomerang (1992)" "Net, The (1995)" "Outbreak (1995)" "Star Trek: Generations (1994)" ...
##   .. ..$ genres   : chr [1:7172311] "Comedy|Romance" "Action|Crime|Thriller" "Action|Drama|Sci-Fi|Thriller" "Action|Adventure|Drama|Sci-Fi" ...
##   ..$ train_mx      : num [1:69878, 1:10677] 5 NA NA NA NA NA NA NA NA NA ...
##   .. ..- attr(*, "dimnames")=List of 2
##   .. .. ..$ : chr [1:69878] "1" "2" "3" "4" ...
##   .. .. ..$ : chr [1:10677] "122" "185" "292" "329" ...
##   ..$ train.sgr     : tibble [18,669,190 x 6] (S3: tbl_df/tbl/data.frame)
##   .. ..$ userId   : int [1:18669190] 1 1 1 1 1 1 1 1 1 1 ...
##   .. ..$ movieId  : int [1:18669190] 122 122 185 185 292 292 292 292 316 316 ...
##   .. ..$ rating   : num [1:18669190] 5 5 5 5 5 5 5 5 5 5 ...
##   .. ..$ timestamp: int [1:18669190] 838985046 838985046 838983525 838983525 838983421 838983421 838983421 838983421 838983392 838983392 ...
##   .. ..$ title    : chr [1:18669190] "Boomerang (1992)" "Boomerang (1992)" "Net, The (1995)" "Net, The (1995)" ...
##   .. ..$ genres   : chr [1:18669190] "Comedy" "Romance" "Action" "Crime" ...
##   ..$ validation_set:'data.frame':   1827744 obs. of  6 variables:
##   .. ..$ userId   : int [1:1827744] 1 1 1 1 2 2 2 2 3 3 ...
##   .. ..$ movieId  : int [1:1827744] 316 355 377 588 260 376 648 1049 110 1252 ...
##   .. ..$ rating   : num [1:1827744] 5 5 5 5 5 3 2 3 4.5 4 ...
##   .. ..$ timestamp: int [1:1827744] 838983392 838984474 838983834 838983339 868244562 868245920 868244699 868245920 1136075500 1133571071 ...
##   .. ..$ title    : chr [1:1827744] "Stargate (1994)" "Flintstones, The (1994)" "Speed (1994)" "Aladdin (1992)" ...
##   .. ..$ genres   : chr [1:1827744] "Action|Adventure|Sci-Fi" "Children|Comedy|Fantasy" "Action|Romance|Thriller" "Adventure|Animation|Children|Comedy|Musical" ...
##  $ :List of 4
##   ..$ train_set     :'data.frame':   7172306 obs. of  6 variables:
##   .. ..$ userId   : int [1:7172306] 1 1 1 1 1 1 1 1 1 1 ...
##   .. ..$ movieId  : int [1:7172306] 122 185 292 316 329 355 356 364 370 377 ...
##   .. ..$ rating   : num [1:7172306] 5 5 5 5 5 5 5 5 5 5 ...
##   .. ..$ timestamp: int [1:7172306] 838985046 838983525 838983421 838983392 838983392 838984474 838983653 838983707 838984596 838983834 ...
##   .. ..$ title    : chr [1:7172306] "Boomerang (1992)" "Net, The (1995)" "Outbreak (1995)" "Stargate (1994)" ...
##   .. ..$ genres   : chr [1:7172306] "Comedy|Romance" "Action|Crime|Thriller" "Action|Drama|Sci-Fi|Thriller" "Action|Adventure|Sci-Fi" ...
##   ..$ train_mx      : num [1:69878, 1:10677] 5 NA NA NA NA NA NA NA NA NA ...
##   .. ..- attr(*, "dimnames")=List of 2
##   .. .. ..$ : chr [1:69878] "1" "2" "3" "4" ...
##   .. .. ..$ : chr [1:10677] "122" "185" "292" "316" ...
##   ..$ train.sgr     : tibble [18,669,201 x 6] (S3: tbl_df/tbl/data.frame)
##   .. ..$ userId   : int [1:18669201] 1 1 1 1 1 1 1 1 1 1 ...
##   .. ..$ movieId  : int [1:18669201] 122 122 185 185 185 292 292 316 316 329 ...
##   .. ..$ rating   : num [1:18669201] 5 5 5 5 5 5 5 5 5 5 ...
##   .. ..$ timestamp: int [1:18669201] 838985046 838985046 838983525 838983525 838983525 838983421 838983421 838983392 838983392 838983392 ...
##   .. ..$ title    : chr [1:18669201] "Boomerang (1992)" "Boomerang (1992)" "Net, The (1995)" "Net, The (1995)" ...
##   .. ..$ genres   : chr [1:18669201] "Comedy" "Romance" "Action" "Crime" ...
##   ..$ validation_set:'data.frame':   1827749 obs. of  6 variables:
##   .. ..$ userId   : int [1:1827749] 1 1 1 1 2 2 2 2 3 3 ...
##   .. ..$ movieId  : int [1:1827749] 362 520 539 594 539 590 733 1210 1252 1408 ...
##   .. ..$ rating   : num [1:1827749] 5 5 5 5 3 5 3 4 4 3.5 ...
##   .. ..$ timestamp: int [1:1827749] 838984885 838984679 838984068 838984679 868246262 868245608 868244562 868245644 1133571071 1133571145 ...
##   .. ..$ title    : chr [1:1827749] "Jungle Book, The (1994)" "Robin Hood: Men in Tights (1993)" "Sleepless in Seattle (1993)" "Snow White and the Seven Dwarfs (1937)" ...
##   .. ..$ genres   : chr [1:1827749] "Adventure|Children|Romance" "Comedy" "Comedy|Drama|Romance" "Animation|Children|Drama|Fantasy|Musical" ...
##  $ :List of 4
##   ..$ train_set     :'data.frame':   7172307 obs. of  6 variables:
##   .. ..$ userId   : int [1:7172307] 1 1 1 1 1 1 1 1 1 1 ...
##   .. ..$ movieId  : int [1:7172307] 122 185 292 316 329 355 362 370 377 420 ...
##   .. ..$ rating   : num [1:7172307] 5 5 5 5 5 5 5 5 5 5 ...
##   .. ..$ timestamp: int [1:7172307] 838985046 838983525 838983421 838983392 838983392 838984474 838984885 838984596 838983834 838983834 ...
##   .. ..$ title    : chr [1:7172307] "Boomerang (1992)" "Net, The (1995)" "Outbreak (1995)" "Stargate (1994)" ...
##   .. ..$ genres   : chr [1:7172307] "Comedy|Romance" "Action|Crime|Thriller" "Action|Drama|Sci-Fi|Thriller" "Action|Adventure|Sci-Fi" ...
##   ..$ train_mx      : num [1:69878, 1:10677] 5 NA NA NA NA NA NA NA NA NA ...
##   .. ..- attr(*, "dimnames")=List of 2
##   .. .. ..$ : chr [1:69878] "1" "2" "3" "4" ...
##   .. .. ..$ : chr [1:10677] "122" "185" "292" "316" ...
##   ..$ train.sgr     : tibble [18,669,195 x 6] (S3: tbl_df/tbl/data.frame)
##   .. ..$ userId   : int [1:18669195] 1 1 1 1 1 1 1 1 1 1 ...
##   .. ..$ movieId  : int [1:18669195] 122 122 185 185 185 292 292 292 316 329 ...
##   .. ..$ rating   : num [1:18669195] 5 5 5 5 5 5 5 5 5 5 ...
##   .. ..$ timestamp: int [1:18669195] 838985046 838985046 838983525 838983525 838983525 838983421 838983421 838983421 838983392 838983392 ...
##   .. ..$ title    : chr [1:18669195] "Boomerang (1992)" "Boomerang (1992)" "Net, The (1995)" "Net, The (1995)" ...
##   .. ..$ genres   : chr [1:18669195] "Comedy" "Romance" "Action" "Crime" ...
##   ..$ validation_set:'data.frame':   1827748 obs. of  6 variables:
##   .. ..$ userId   : int [1:1827748] 1 1 1 1 2 2 2 2 3 3 ...
##   .. ..$ movieId  : int [1:1827748] 356 364 539 616 590 719 780 786 151 213 ...
##   .. ..$ rating   : num [1:1827748] 5 5 5 5 5 3 3 3 4.5 5 ...
##   .. ..$ timestamp: int [1:1827748] 838983653 838983707 838984068 838984941 868245608 868246191 868244698 868244562 1133571026 1136075789 ...
##   .. ..$ title    : chr [1:1827748] "Forrest Gump (1994)" "Lion King, The (1994)" "Sleepless in Seattle (1993)" "Aristocats, The (1970)" ...
##   .. ..$ genres   : chr [1:1827748] "Comedy|Drama|Romance|War" "Adventure|Animation|Children|Drama|Musical" "Comedy|Drama|Romance" "Animation|Children" ...
##  $ :List of 4
##   ..$ train_set     :'data.frame':   7172311 obs. of  6 variables:
##   .. ..$ userId   : int [1:7172311] 1 1 1 1 1 1 1 1 1 1 ...
##   .. ..$ movieId  : int [1:7172311] 122 185 292 316 329 355 356 362 364 370 ...
##   .. ..$ rating   : num [1:7172311] 5 5 5 5 5 5 5 5 5 5 ...
##   .. ..$ timestamp: int [1:7172311] 838985046 838983525 838983421 838983392 838983392 838984474 838983653 838984885 838983707 838984596 ...
##   .. ..$ title    : chr [1:7172311] "Boomerang (1992)" "Net, The (1995)" "Outbreak (1995)" "Stargate (1994)" ...
##   .. ..$ genres   : chr [1:7172311] "Comedy|Romance" "Action|Crime|Thriller" "Action|Drama|Sci-Fi|Thriller" "Action|Adventure|Sci-Fi" ...
##   ..$ train_mx      : num [1:69878, 1:10677] 5 NA NA NA NA NA NA NA NA NA ...
##   .. ..- attr(*, "dimnames")=List of 2
##   .. .. ..$ : chr [1:69878] "1" "2" "3" "4" ...
##   .. .. ..$ : chr [1:10677] "122" "185" "292" "316" ...
##   ..$ train.sgr     : tibble [18,669,192 x 6] (S3: tbl_df/tbl/data.frame)
##   .. ..$ userId   : int [1:18669192] 1 1 1 1 1 1 1 1 1 1 ...
##   .. ..$ movieId  : int [1:18669192] 122 122 185 185 292 292 316 316 329 329 ...
##   .. ..$ rating   : num [1:18669192] 5 5 5 5 5 5 5 5 5 5 ...
##   .. ..$ timestamp: int [1:18669192] 838985046 838985046 838983525 838983525 838983421 838983421 838983392 838983392 838983392 838983392 ...
##   .. ..$ title    : chr [1:18669192] "Boomerang (1992)" "Boomerang (1992)" "Net, The (1995)" "Net, The (1995)" ...
##   .. ..$ genres   : chr [1:18669192] "Comedy" "Romance" "Action" "Thriller" ...
##   ..$ validation_set:'data.frame':   1827744 obs. of  6 variables:
##   .. ..$ userId   : int [1:1827744] 1 1 1 1 2 2 2 2 3 3 ...
##   .. ..$ movieId  : int [1:1827744] 377 520 588 616 110 648 1049 1356 1148 1276 ...
##   .. ..$ rating   : num [1:1827744] 5 5 5 5 5 2 3 3 4 3.5 ...
##   .. ..$ timestamp: int [1:1827744] 838983834 838984679 838983339 838984941 868245777 868244699 868245920 868244603 1133571121 1133571205 ...
##   .. ..$ title    : chr [1:1827744] "Speed (1994)" "Robin Hood: Men in Tights (1993)" "Aladdin (1992)" "Aristocats, The (1970)" ...
##   .. ..$ genres   : chr [1:1827744] "Action|Romance|Thriller" "Comedy" "Adventure|Animation|Children|Comedy|Musical" "Animation|Children" ...
##  $ :List of 4
##   ..$ train_set     :'data.frame':   7172301 obs. of  6 variables:
##   .. ..$ userId   : int [1:7172301] 1 1 1 1 1 1 1 1 1 1 ...
##   .. ..$ movieId  : int [1:7172301] 122 185 292 316 355 356 364 370 420 466 ...
##   .. ..$ rating   : num [1:7172301] 5 5 5 5 5 5 5 5 5 5 ...
##   .. ..$ timestamp: int [1:7172301] 838985046 838983525 838983421 838983392 838984474 838983653 838983707 838984596 838983834 838984679 ...
##   .. ..$ title    : chr [1:7172301] "Boomerang (1992)" "Net, The (1995)" "Outbreak (1995)" "Stargate (1994)" ...
##   .. ..$ genres   : chr [1:7172301] "Comedy|Romance" "Action|Crime|Thriller" "Action|Drama|Sci-Fi|Thriller" "Action|Adventure|Sci-Fi" ...
##   ..$ train_mx      : num [1:69878, 1:10677] 5 NA NA NA NA NA NA NA NA NA ...
##   .. ..- attr(*, "dimnames")=List of 2
##   .. .. ..$ : chr [1:69878] "1" "2" "3" "4" ...
##   .. .. ..$ : chr [1:10677] "122" "185" "292" "316" ...
##   ..$ train.sgr     : tibble [18,669,194 x 6] (S3: tbl_df/tbl/data.frame)
##   .. ..$ userId   : int [1:18669194] 1 1 1 1 1 1 1 1 1 1 ...
##   .. ..$ movieId  : int [1:18669194] 122 122 185 185 292 292 316 329 329 355 ...
##   .. ..$ rating   : num [1:18669194] 5 5 5 5 5 5 5 5 5 5 ...
##   .. ..$ timestamp: int [1:18669194] 838985046 838985046 838983525 838983525 838983421 838983421 838983392 838983392 838983392 838984474 ...
##   .. ..$ title    : chr [1:18669194] "Boomerang (1992)" "Boomerang (1992)" "Net, The (1995)" "Net, The (1995)" ...
##   .. ..$ genres   : chr [1:18669194] "Comedy" "Romance" "Crime" "Thriller" ...
##   ..$ validation_set:'data.frame':   1827754 obs. of  6 variables:
##   .. ..$ userId   : int [1:1827754] 1 1 1 1 2 2 2 2 3 3 ...
##   .. ..$ movieId  : int [1:1827754] 329 362 377 594 110 376 539 736 1252 1408 ...
##   .. ..$ rating   : num [1:1827754] 5 5 5 5 5 3 3 3 4 3.5 ...
##   .. ..$ timestamp: int [1:1827754] 838983392 838984885 838983834 838984679 868245777 868245920 868246262 868244698 1133571071 1133571145 ...
##   .. ..$ title    : chr [1:1827754] "Star Trek: Generations (1994)" "Jungle Book, The (1994)" "Speed (1994)" "Snow White and the Seven Dwarfs (1937)" ...
##   .. ..$ genres   : chr [1:1827754] "Action|Adventure|Drama|Sci-Fi" "Adventure|Children|Romance" "Action|Romance|Thriller" "Animation|Children|Drama|Fantasy|Musical" ...
\end{verbatim}

\begin{noteblock}
This code snippet is a part of the
\href{https://github.com/AzKurban-edX-DS/Capstone-MovieLens/blob/2c5d96ac98a8b8fa4151aa8295f91ac29d9472b3/r/src/support-functions/data.helper.functions.R\#L87}{\texttt{make\_source\_datasets}
\emph{function} code} described above.

\end{noteblock}

Note that we used the \texttt{sample\_train\_validation\_sets} function
call to split the original dataset (\texttt{edx} in this case):

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{    split\_sets }\OtherTok{\textless{}{-}}\NormalTok{ edx }\SpecialCharTok{|\textgreater{}}
      \FunctionTok{sample\_train\_validation\_sets}\NormalTok{(fold\_i}\SpecialCharTok{*}\DecValTok{1000}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

which returns a pair of train/validation sets:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{sample\_train\_validation\_sets }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(data, seed)\{}
  \FunctionTok{put\_log}\NormalTok{(}\StringTok{"Function: \textasciigrave{}sample\_train\_validation\_sets\textasciigrave{}: Sampling 20\% of the \textasciigrave{}data\textasciigrave{} data..."}\NormalTok{)}
  \FunctionTok{set.seed}\NormalTok{(seed)}
\NormalTok{  validation\_ind }\OtherTok{\textless{}{-}} 
    \FunctionTok{sapply}\NormalTok{(}\FunctionTok{splitByUser}\NormalTok{(data),}
           \ControlFlowTok{function}\NormalTok{(i) }\FunctionTok{sample}\NormalTok{(i, }\FunctionTok{ceiling}\NormalTok{(}\FunctionTok{length}\NormalTok{(i)}\SpecialCharTok{*}\NormalTok{.}\DecValTok{2}\NormalTok{))) }\SpecialCharTok{|\textgreater{}} 
    \FunctionTok{unlist}\NormalTok{() }\SpecialCharTok{|\textgreater{}} 
    \FunctionTok{sort}\NormalTok{()}
  
  \FunctionTok{put\_log}\NormalTok{(}\StringTok{"Function: \textasciigrave{}sample\_train\_validation\_sets\textasciigrave{}: }
\StringTok{Extracting 80\% of the original \textasciigrave{}data\textasciigrave{} not used for the Validation Set, }
\StringTok{excluding data for users who provided no more than a specified number of ratings: \{min\_nratings\}."}\NormalTok{)}
  
\NormalTok{  train\_set }\OtherTok{\textless{}{-}}\NormalTok{ data[}\SpecialCharTok{{-}}\NormalTok{validation\_ind,]}
  
  \FunctionTok{put\_log}\NormalTok{(}\StringTok{"Function: \textasciigrave{}sample\_train\_validation\_sets\textasciigrave{}: Dataset created: train\_set"}\NormalTok{)}
  \FunctionTok{put}\NormalTok{(}\FunctionTok{summary}\NormalTok{(train\_set))}
  
  \FunctionTok{put\_log}\NormalTok{(}\StringTok{"Function: \textasciigrave{}sample\_train\_validation\_sets\textasciigrave{}: }
\StringTok{To make sure we dont include movies in the Training Set that should not be there, }
\StringTok{we exclude entries using the semi\_join function from the Validation Set."}\NormalTok{)}
\NormalTok{  tmp.data }\OtherTok{\textless{}{-}}\NormalTok{ data[validation\_ind,]}
  
\NormalTok{  validation\_set }\OtherTok{\textless{}{-}}\NormalTok{ tmp.data }\SpecialCharTok{|\textgreater{}} 
    \FunctionTok{semi\_join}\NormalTok{(train\_set, }\AttributeTok{by =} \StringTok{"movieId"}\NormalTok{) }\SpecialCharTok{|\textgreater{}} 
    \FunctionTok{semi\_join}\NormalTok{(train\_set, }\AttributeTok{by =} \StringTok{"userId"}\NormalTok{) }\SpecialCharTok{|\textgreater{}}
    \FunctionTok{as.data.frame}\NormalTok{()}
  
  \CommentTok{\# Add rows excluded from \textasciigrave{}validation\_set\textasciigrave{} into \textasciigrave{}train\_set\textasciigrave{}}
\NormalTok{  tmp.excluded }\OtherTok{\textless{}{-}} \FunctionTok{anti\_join}\NormalTok{(tmp.data, validation\_set)}
\NormalTok{  train\_set }\OtherTok{\textless{}{-}} \FunctionTok{rbind}\NormalTok{(train\_set, tmp.excluded)}
  
  \FunctionTok{put\_log}\NormalTok{(}\StringTok{"Function: \textasciigrave{}sample\_train\_validation\_sets\textasciigrave{}: Dataset created: validation\_set"}\NormalTok{)}
  \FunctionTok{put}\NormalTok{(}\FunctionTok{summary}\NormalTok{(validation\_set))}

  \CommentTok{\# CV train \& test sets Consistency Test}
\NormalTok{  validation.left\_join.Nas }\OtherTok{\textless{}{-}}\NormalTok{ train\_set }\SpecialCharTok{|\textgreater{}}
    \FunctionTok{mutate}\NormalTok{(}\AttributeTok{tst.col =}\NormalTok{ rating) }\SpecialCharTok{|\textgreater{}}
    \FunctionTok{select}\NormalTok{(userId, movieId, tst.col) }\SpecialCharTok{|\textgreater{}}
    \FunctionTok{data.consistency.test}\NormalTok{(validation\_set)}
  
  \FunctionTok{put\_log}\NormalTok{(}\StringTok{"Function: \textasciigrave{}sample\_train\_validation\_sets\textasciigrave{}:}
\StringTok{Below are the data consistency verification results"}\NormalTok{)}
  \FunctionTok{put}\NormalTok{(validation.left\_join.Nas)}
  
  \CommentTok{\# Return result datassets {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}    }
  \FunctionTok{list}\NormalTok{(}\AttributeTok{train\_set =}\NormalTok{ train\_set, }
       \AttributeTok{validation\_set =}\NormalTok{ validation\_set)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\begin{noteblock}
The
\href{https://github.com/AzKurban-edX-DS/Capstone-MovieLens/blob/2c5d96ac98a8b8fa4151aa8295f91ac29d9472b3/r/src/support-functions/data.helper.functions.R\#L15}{\texttt{sample\_train\_validation\_sets}
function} is defined in the same script as the
\texttt{make\_source\_datasets} one, from where it is called.

\end{noteblock}

\paragraph{Common Helper Functions}\label{common-helper-functions}

\hfill\break

For our further analysis, we are going to use the following \_common
helper functions:

\subparagraph{\texorpdfstring{\texttt{clamp}
function}{clamp function}}\label{clamp-function}

\hfill\break

As explained in
\href{https://rafalab.dfci.harvard.edu/dsbook-part-2/highdim/regularization.html\#user-effects}{Section
24.4 User effects} of the \emph{Course Textbook} we know ratings can't
be below 0.5 or above 5. For this reason, we will use the \texttt{clamp}
function described in that section:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{clamp }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x, }\AttributeTok{min =} \FloatTok{0.5}\NormalTok{, }\AttributeTok{max =} \DecValTok{5}\NormalTok{) }\FunctionTok{pmax}\NormalTok{(}\FunctionTok{pmin}\NormalTok{(x, max), min)}
\end{Highlighting}
\end{Shaded}

\subparagraph{\texorpdfstring{Functions to calculate \emph{(Root) Mean
Squared
Error}}{Functions to calculate (Root) Mean Squared Error}}\label{functions-to-calculate-root-mean-squared-error}

\hfill\break

We will need the following functions to calculate \emph{(R)MSEs}:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mse }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(r) }\FunctionTok{mean}\NormalTok{(r}\SpecialCharTok{\^{}}\DecValTok{2}\NormalTok{)}

\NormalTok{mse\_cv }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(r\_list) \{}
\NormalTok{  mses }\OtherTok{\textless{}{-}} \FunctionTok{sapply}\NormalTok{(r\_list, }\FunctionTok{mse}\NormalTok{(r))}
  \FunctionTok{mean}\NormalTok{(mses)}
\NormalTok{\}}

\NormalTok{rmse }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(r) }\FunctionTok{sqrt}\NormalTok{(}\FunctionTok{mse}\NormalTok{(r))}
\CommentTok{\# rmse\_cv \textless{}{-} function(r\_list) sqrt(mse\_cv(r\_list))}

\NormalTok{rmse2 }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(true\_ratings, predicted\_ratings) \{}
  \FunctionTok{rmse}\NormalTok{(true\_ratings }\SpecialCharTok{{-}}\NormalTok{ predicted\_ratings)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\subsubsection{Overall Mean Rating (Naive)
Model}\label{overall-mean-rating-naive-model}

\hfill\break

Let's begin our analysis by evaluating the simplest model described in
\href{https://rafalab.dfci.harvard.edu/dsbook-part-2/highdim/regularization.html\#a-first-model}{Section
\emph{23.3 The First Model} of the \emph{Course Textbook}}, and then
gradually refine it through further research. It is about a model that
assumes the same rating for all movies and users with all the
differences explained by random variation would look as follows:

\[
Y_{i,j} = \mu + \varepsilon_{i,j}
\]

with \(\varepsilon_{i,j}\) independent errors sampled from the same
distribution centered at 0 and \(\mu\) the \emph{true} rating for all
movies.

We know that the estimate that minimizes the RMSE is the least squares
estimate of \(\mu\) and, in this case, is the average of all ratings:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{  mu }\OtherTok{\textless{}{-}} \FunctionTok{mean}\NormalTok{(edx}\SpecialCharTok{$}\NormalTok{rating)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{print}\NormalTok{(mu)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 3.47184
\end{verbatim}

If we predict all unknown ratings with \(\hat{\mu}\), we obtain the
following RMSE:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{  mu.RMSE }\OtherTok{\textless{}{-}} \FunctionTok{sqrt}\NormalTok{(}\FunctionTok{mean}\NormalTok{(MSEs))}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mu.RMSE}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 1.060346
\end{verbatim}

If we plug in any other number, we will get a higher RMSE. Let's prove
that by the following small investigation:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{deviation }\OtherTok{\textless{}{-}} \FunctionTok{seq}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{6}\NormalTok{, }\FloatTok{0.1}\NormalTok{) }\SpecialCharTok{{-}} \DecValTok{3}
\FunctionTok{print}\NormalTok{(deviation)}

\NormalTok{rmse\_value }\OtherTok{\textless{}{-}} \FunctionTok{sapply}\NormalTok{(deviation, }\ControlFlowTok{function}\NormalTok{(diff)\{}
  \FunctionTok{rmse}\NormalTok{(test\_set}\SpecialCharTok{$}\NormalTok{rating }\SpecialCharTok{{-}}\NormalTok{ mu }\SpecialCharTok{+}\NormalTok{ diff)}
\NormalTok{\})}

\FunctionTok{plot}\NormalTok{(deviation, rmse\_value, }\AttributeTok{type =} \StringTok{"l"}\NormalTok{)}

\FunctionTok{sprintf}\NormalTok{(}\StringTok{"Minimum RMSE is achieved when the deviation from the mean is: \%s"}\NormalTok{, }
\NormalTok{        deviation[}\FunctionTok{which.min}\NormalTok{(rmse\_value)])}
\end{Highlighting}
\end{Shaded}

To win the grand prize of \$1,000,000, a participating team had to get
an RMSE of at least 0.8563\autocite{BigChaosSln}. So we can definitely
do better!\autocite{IDS2_23-3}

\subsubsection{Taking into account User
effects}\label{taking-into-account-user-effects}

\hfill\break
To improve our model let's now take into consideration user effects as
explained in
\href{https://rafalab.dfci.harvard.edu/dsbook-part-2/highdim/regularization.html\#user-effects}{Section
\emph{23.4 User effects} of the \emph{Course Textbook}}. If we visualize
the average rating for each user the way the
\href{https://x.com/rafalab}{the author} shows, we can see that there is
substantial variability in the average ratings across users:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{hist}\NormalTok{(edx.user\_mean\_ratings}\SpecialCharTok{$}\NormalTok{mean\_rating, }\AttributeTok{nclass =} \DecValTok{30}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{capstone-movielens-report.draft4_files/figure-latex/unnamed-chunk-42-1.pdf}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{print}\NormalTok{(}\StringTok{"A histogram of the User Mean Rating distribution has been plotted."}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "A histogram of the User Mean Rating distribution has been plotted."
\end{verbatim}

Following the author's further explanation, to account for this
variability, we will use a linear model with a \emph{treatment effect}
\(\alpha_i\) for each user. The sum \(\mu+\alpha_i\) can be interpreted
as the typical rating user \(i\) gives to movies. So we write the model
as follows:

\[
Y_{i,j} = \mu + \alpha_i + \varepsilon_{i,j}
\]

Statistics textbooks refer to the \(\alpha\)s as treatment effects. In
the Netflix challenge papers, they refer to them as
\emph{bias}\autocite{IDS2_23-4,MFT_RS}.

As it is stated here\autocite{IDS2_23-4}, it can be shown that the least
squares estimate \(\hat{\alpha}_i\) is just the average of
\(y_{i,j} - \hat{\mu}\) for each user \(i\). So we compute them this
way:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a }\OtherTok{\textless{}{-}} \FunctionTok{rowMeans}\NormalTok{(y }\SpecialCharTok{{-}}\NormalTok{ mu, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

Finally, we are ready to compute the \texttt{RMSE} (additionally using
the helper function \texttt{clamp} we defined above to keep predictions
in the proper range):

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Compute the RMSE taking into account user effects:}
\NormalTok{user\_effects\_rmse }\OtherTok{\textless{}{-}}\NormalTok{ test\_set }\SpecialCharTok{|\textgreater{}} 
    \FunctionTok{left\_join}\NormalTok{(}\FunctionTok{data.frame}\NormalTok{(}\AttributeTok{userId =} \FunctionTok{as.integer}\NormalTok{(}\FunctionTok{names}\NormalTok{(a)), }\AttributeTok{a =}\NormalTok{ a), }\AttributeTok{by =} \StringTok{"userId"}\NormalTok{) }\SpecialCharTok{|\textgreater{}}
    \FunctionTok{mutate}\NormalTok{(}\AttributeTok{resid =}\NormalTok{ rating }\SpecialCharTok{{-}} \FunctionTok{clamp}\NormalTok{(mu }\SpecialCharTok{+}\NormalTok{ a)) }\SpecialCharTok{|\textgreater{}} 
    \FunctionTok{filter}\NormalTok{(}\SpecialCharTok{!}\FunctionTok{is.na}\NormalTok{(resid)) }\SpecialCharTok{|\textgreater{}}
    \FunctionTok{pull}\NormalTok{(resid) }\SpecialCharTok{|\textgreater{}} \FunctionTok{rmse}\NormalTok{()}

\FunctionTok{print}\NormalTok{(user\_effects\_rmse)}
\end{Highlighting}
\end{Shaded}

\subsubsection{Taking into account Movie
effects}\label{taking-into-account-movie-effects}

\hfill\break
In
\href{https://rafalab.dfci.harvard.edu/dsbook-part-2/highdim/regularization.html\#movie-effects}{Section
\emph{23.5 Movie effects} of the \emph{Course Textbook}} the author
draws our attention to the fact that some movies are generally rated
higher than others. He also explains that~a linear model with a
\emph{treatment effect} \(\beta_j\) for each movie can be used in this
case, which can be interpreted as movie effect or the difference between
the average ranking for movie \(j\) and the overall average \(\mu\):

\[
Y_{i,j} = \mu + \alpha_i + \beta_j +\varepsilon_{i,j}
\] The author then shows how to use an approximation by first computing
the least square estimate \(\hat{\mu}\) and \(\hat{\alpha}_i\), and then
estimating \(\hat{\beta}_j\) as the average of the residuals
\(y_{i,j} - \hat{\mu} - \hat{\alpha}_i\):

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{b }\OtherTok{\textless{}{-}} \FunctionTok{colMeans}\NormalTok{(y }\SpecialCharTok{{-}}\NormalTok{ mu }\SpecialCharTok{{-}}\NormalTok{ a, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

We can now construct predictors and see how much the \texttt{RMSE}
improves\autocite{IDS2_23-5}:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{user\_and\_movie\_effects\_rmse }\OtherTok{\textless{}{-}}\NormalTok{ test\_set }\SpecialCharTok{|\textgreater{}} 
    \FunctionTok{left\_join}\NormalTok{(}\FunctionTok{data.frame}\NormalTok{(}\AttributeTok{userId =} \FunctionTok{as.integer}\NormalTok{(}\FunctionTok{names}\NormalTok{(a)), }\AttributeTok{a =}\NormalTok{ a), }\AttributeTok{by =} \StringTok{"userId"}\NormalTok{) }\SpecialCharTok{|\textgreater{}}
    \FunctionTok{left\_join}\NormalTok{(}\FunctionTok{data.frame}\NormalTok{(}\AttributeTok{movieId =} \FunctionTok{as.integer}\NormalTok{(}\FunctionTok{names}\NormalTok{(b)), }\AttributeTok{b =}\NormalTok{ b), }\AttributeTok{by =} \StringTok{"movieId"}\NormalTok{) }\SpecialCharTok{|\textgreater{}}
    \FunctionTok{mutate}\NormalTok{(}\AttributeTok{resid =}\NormalTok{ rating }\SpecialCharTok{{-}} \FunctionTok{clamp}\NormalTok{(mu }\SpecialCharTok{+}\NormalTok{ a }\SpecialCharTok{+}\NormalTok{ b)) }\SpecialCharTok{|\textgreater{}}  
    \FunctionTok{filter}\NormalTok{(}\SpecialCharTok{!}\FunctionTok{is.na}\NormalTok{(resid)) }\SpecialCharTok{|\textgreater{}}
    \FunctionTok{pull}\NormalTok{(resid) }\SpecialCharTok{|\textgreater{}} \FunctionTok{rmse}\NormalTok{()}

\FunctionTok{print}\NormalTok{(user\_and\_movie\_effects\_rmse)}
\end{Highlighting}
\end{Shaded}

\subsubsection{Utilizing Penalized least
squares}\label{utilizing-penalized-least-squares}

\hfill\break
\href{https://rafalab.dfci.harvard.edu/dsbook-part-2/highdim/regularization.html\#penalized-least-squares}{Section
\emph{23.6 Penalized least squares} of the \emph{Course Textbook}}
explains why and how we should use \emph{Penalized least squares} to
improve our predictions. The author also explains that the general idea
of penalized regression is to control the total variability of the movie
effects: \(\sum_{j=1}^n \beta_j^2\). Specifically, instead of minimizing
the least squares equation, we minimize an equation that adds a penalty:

\[ 
\sum_{i,j} \left(y_{u,i} - \mu - \alpha_i - \beta_j \right)^2 + \lambda \sum_{j} \beta_j^2
\] The first term is just the sum of squares and the second is a penalty
that gets larger when many \(\beta_i\)s are large. Using calculus, we
can actually show that the values of \(\beta_i\) that minimize this
equation are:

\[
\hat{\beta}_j(\lambda) = \frac{1}{\lambda + n_j} \sum_{i=1}^{n_i} \left(Y_{i,j} - \mu - \alpha_i\right)
\]

where \(n_j\) is the number of ratings made for movie \(j\).

This approach will have our desired effect: when our sample size \(n_j\)
is very large, we obtain a stable estimate and the penalty \(\lambda\)
is effectively ignored since \(n_j+\lambda \approx n_j\). Yet when the
\(n_j\) is small, then the estimate \(\hat{\beta}_i(\lambda)\) is
shrunken towards 0. The larger the \(\lambda\), the more we
shrink\autocite{IDS2_23-6}.

\paragraph{Support function}\label{support-function}

\hfill\break
We will use the following function to calculate \emph{RMSE} in this
section:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{reg\_rmse }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(b)\{}
\NormalTok{  test\_set }\SpecialCharTok{|\textgreater{}} 
    \FunctionTok{left\_join}\NormalTok{(}\FunctionTok{data.frame}\NormalTok{(}\AttributeTok{userId =} \FunctionTok{as.integer}\NormalTok{(}\FunctionTok{names}\NormalTok{(a)), }\AttributeTok{a =}\NormalTok{ a), }\AttributeTok{by =} \StringTok{"userId"}\NormalTok{) }\SpecialCharTok{|\textgreater{}}
    \FunctionTok{left\_join}\NormalTok{(}\FunctionTok{data.frame}\NormalTok{(}\AttributeTok{movieId =} \FunctionTok{as.integer}\NormalTok{(}\FunctionTok{names}\NormalTok{(b)), }\AttributeTok{b =}\NormalTok{ b), }\AttributeTok{by =} \StringTok{"movieId"}\NormalTok{) }\SpecialCharTok{|\textgreater{}}
    \FunctionTok{mutate}\NormalTok{(}\AttributeTok{resid =}\NormalTok{ rating }\SpecialCharTok{{-}} \FunctionTok{clamp}\NormalTok{(mu }\SpecialCharTok{+}\NormalTok{ a }\SpecialCharTok{+}\NormalTok{ b)) }\SpecialCharTok{|\textgreater{}} 
    \FunctionTok{filter}\NormalTok{(}\SpecialCharTok{!}\FunctionTok{is.na}\NormalTok{(resid)) }\SpecialCharTok{|\textgreater{}}
    \FunctionTok{pull}\NormalTok{(resid) }\SpecialCharTok{|\textgreater{}} \FunctionTok{rmse}\NormalTok{()}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

Let's now figure out the \(\lambda\) that minimizes the \emph{RMSE}:

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Here we will simply compute the RMSE for different values of \textasciigrave{}lambda\textasciigrave{} }
\NormalTok{n }\OtherTok{\textless{}{-}} \FunctionTok{colSums}\NormalTok{(}\SpecialCharTok{!}\FunctionTok{is.na}\NormalTok{(y))}

\NormalTok{sums }\OtherTok{\textless{}{-}} \FunctionTok{colSums}\NormalTok{(y }\SpecialCharTok{{-}}\NormalTok{ mu }\SpecialCharTok{{-}}\NormalTok{ a, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{lambdas }\OtherTok{\textless{}{-}} \FunctionTok{seq}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{10}\NormalTok{, }\FloatTok{0.1}\NormalTok{)}

\NormalTok{rmses }\OtherTok{\textless{}{-}} \FunctionTok{sapply}\NormalTok{(lambdas, }\ControlFlowTok{function}\NormalTok{(lambda)\{}
\NormalTok{  b }\OtherTok{\textless{}{-}}\NormalTok{  sums }\SpecialCharTok{/}\NormalTok{ (n }\SpecialCharTok{+}\NormalTok{ lambda)}
  \FunctionTok{reg\_rmse}\NormalTok{(b)}
\NormalTok{\})}

\CommentTok{\# Here is a plot of the RMSE versus \textasciigrave{}lambda\textasciigrave{}:}
\FunctionTok{plot}\NormalTok{(lambdas, rmses, }\AttributeTok{type =} \StringTok{"l"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

Now we can determine the minimal \emph{RMSE}:

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# print(min(rmses))}
\end{Highlighting}
\end{Shaded}

which is achieved for the following \(\lambda\):

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{lambda }\OtherTok{\textless{}{-}}\NormalTok{ lambdas[}\FunctionTok{which.min}\NormalTok{(rmses)] }
\FunctionTok{print}\NormalTok{(lambda)}
\end{Highlighting}
\end{Shaded}

Using this \(\lambda\) we can compute the regularized estimates:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{b\_reg }\OtherTok{\textless{}{-}}\NormalTok{ sums }\SpecialCharTok{/}\NormalTok{ (n }\SpecialCharTok{+}\NormalTok{ lambda)}

\FunctionTok{str}\NormalTok{(b\_reg)}
\end{Highlighting}
\end{Shaded}

Finally, let's verify that the penalized estimates
\(\hat{b}_i(\lambda)\) we have just computed actually result in the
minimal \emph{RMSE} figured out above:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{reg\_rmse}\NormalTok{(b\_reg)}
\end{Highlighting}
\end{Shaded}

\subsubsection{Accounting for Date
effects}\label{accounting-for-date-effects}

\subparagraph{\texorpdfstring{Yearly rating
count\autocite{MRS-R-BEST}}{Yearly rating count{[}@MRS-R-BEST{]}}}\label{yearly-rating-countmrs-r-best}

\hfill\break

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{print}\NormalTok{(edx }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{year =} \FunctionTok{year}\NormalTok{(}\FunctionTok{as\_datetime}\NormalTok{(timestamp, }\AttributeTok{origin =} \StringTok{"1970{-}01{-}01"}\NormalTok{))) }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{group\_by}\NormalTok{(year) }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{summarize}\NormalTok{(}\AttributeTok{count =} \FunctionTok{n}\NormalTok{())}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A tibble: 15 x 2
##     year   count
##    <dbl>   <int>
##  1  1995       2
##  2  1996  942772
##  3  1997  414101
##  4  1998  181634
##  5  1999  709893
##  6  2000 1144349
##  7  2001  683355
##  8  2002  524959
##  9  2003  619938
## 10  2004  691429
## 11  2005 1059277
## 12  2006  689315
## 13  2007  629168
## 14  2008  696740
## 15  2009   13123
\end{verbatim}

\subparagraph{\texorpdfstring{Average rating per year
plot\autocite{MRS-R-BEST}}{Average rating per year plot{[}@MRS-R-BEST{]}}}\label{average-rating-per-year-plotmrs-r-best}

\hfill\break

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{edx }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{year =} \FunctionTok{year}\NormalTok{(}\FunctionTok{as\_datetime}\NormalTok{(timestamp, }\AttributeTok{origin =} \StringTok{"1970{-}01{-}01"}\NormalTok{))) }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{group\_by}\NormalTok{(year) }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{summarize}\NormalTok{(}\AttributeTok{rating\_avg =} \FunctionTok{mean}\NormalTok{(rating)) }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{ggplot}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ year, }\AttributeTok{y =}\NormalTok{ rating\_avg)) }\SpecialCharTok{+}
  \FunctionTok{geom\_bar}\NormalTok{(}\AttributeTok{stat =} \StringTok{"identity"}\NormalTok{, }\AttributeTok{fill =} \StringTok{"\#8888ff"}\NormalTok{) }\SpecialCharTok{+} 
  \FunctionTok{ggtitle}\NormalTok{(}\StringTok{"Average rating per year"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{xlab}\NormalTok{(}\StringTok{"Year"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{ylab}\NormalTok{(}\StringTok{"Average rating"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{scale\_y\_continuous}\NormalTok{(}\AttributeTok{labels =}\NormalTok{ comma) }\SpecialCharTok{+} 
  \FunctionTok{theme\_economist}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}\AttributeTok{axis.title.x =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{vjust =} \SpecialCharTok{{-}}\DecValTok{5}\NormalTok{, }\AttributeTok{face =} \StringTok{"bold"}\NormalTok{), }
        \AttributeTok{axis.title.y =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{vjust =} \DecValTok{10}\NormalTok{, }\AttributeTok{face =} \StringTok{"bold"}\NormalTok{), }
        \AttributeTok{plot.margin =} \FunctionTok{margin}\NormalTok{(}\FloatTok{0.7}\NormalTok{, }\FloatTok{0.5}\NormalTok{, }\DecValTok{1}\NormalTok{, }\FloatTok{1.2}\NormalTok{, }\StringTok{"cm"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\includegraphics{capstone-movielens-report.draft4_files/figure-latex/unnamed-chunk-54-1.pdf}

We use the following models to account for the \texttt{date} effect:

\[
Y_{i,j} = \mu + \alpha_i + \beta_j + f(d_{i,j}) + \varepsilon_{i,j}
\]

\subsubsection{Accounting for Genre
effect}\label{accounting-for-genre-effect}

\hfill\break
As mentioned in
\href{https://rafalab.dfci.harvard.edu/dsbook-part-2/highdim/regularization.html\#exercises}{Section
23.7: Exercises} of the \emph{Chapter ``23 Regularization'' of the
Course Textbook} the \texttt{Movielens} dataset also has a genres
column. This column includes every genre that applies to the movie (some
movies fall under several genres)\autocite{IDS2_23-7}.

\paragraph{Genre Data Analysis}\label{genre-data-analysis}

\hfill\break
\#\#\#\#\# Movie Genres Data\\
The following code computes movie rating summaries by popular genres
like Drama, Comedy, Thriller, and Romance:

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\#library(stringr)}
\NormalTok{genres }\OtherTok{=} \FunctionTok{c}\NormalTok{(}\StringTok{"Drama"}\NormalTok{, }\StringTok{"Comedy"}\NormalTok{, }\StringTok{"Thriller"}\NormalTok{, }\StringTok{"Romance"}\NormalTok{)}
\FunctionTok{sapply}\NormalTok{(genres, }\ControlFlowTok{function}\NormalTok{(g) \{}
  \FunctionTok{sum}\NormalTok{(}\FunctionTok{str\_detect}\NormalTok{(edx}\SpecialCharTok{$}\NormalTok{genres, g))}
\NormalTok{\})}
\end{Highlighting}
\end{Shaded}

Further, we can find out the movies that have the greatest number of
ratings using the following code:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ordered\_movie\_ratings }\OtherTok{\textless{}{-}}\NormalTok{ edx }\SpecialCharTok{|\textgreater{}} \FunctionTok{group\_by}\NormalTok{(movieId, title) }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{summarize}\NormalTok{(}\AttributeTok{number\_of\_ratings =} \FunctionTok{n}\NormalTok{()) }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{arrange}\NormalTok{(}\FunctionTok{desc}\NormalTok{(number\_of\_ratings))}
\FunctionTok{print}\NormalTok{(}\FunctionTok{head}\NormalTok{(ordered\_movie\_ratings))}
\end{Highlighting}
\end{Shaded}

and figure out the most given ratings in order from most to least:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ratings }\OtherTok{\textless{}{-}}\NormalTok{ edx }\SpecialCharTok{|\textgreater{}}  \FunctionTok{group\_by}\NormalTok{(rating) }\SpecialCharTok{|\textgreater{}}
     \FunctionTok{summarise}\NormalTok{(}\AttributeTok{count =} \FunctionTok{n}\NormalTok{()) }\SpecialCharTok{|\textgreater{}}
     \FunctionTok{arrange}\NormalTok{(}\FunctionTok{desc}\NormalTok{(count))}
\FunctionTok{print}\NormalTok{(ratings)}
\end{Highlighting}
\end{Shaded}

The following code allows us to summarize that in general, half-star
ratings are less common than whole-star ratings (e.g., there are fewer
ratings of 3.5 than there are ratings of 3 or 4, etc.):

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{print}\NormalTok{(edx }\SpecialCharTok{|\textgreater{}} \FunctionTok{group\_by}\NormalTok{(rating) }\SpecialCharTok{|\textgreater{}} \FunctionTok{summarize}\NormalTok{(}\AttributeTok{count =} \FunctionTok{n}\NormalTok{()))}
\end{Highlighting}
\end{Shaded}

We can visually see that from the following plot:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{edx }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{group\_by}\NormalTok{(rating) }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{summarize}\NormalTok{(}\AttributeTok{count =} \FunctionTok{n}\NormalTok{()) }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{ggplot}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ rating, }\AttributeTok{y =}\NormalTok{ count)) }\SpecialCharTok{+}
  \FunctionTok{geom\_line}\NormalTok{() }
\end{Highlighting}
\end{Shaded}

\subparagraph{Movie Genres Effect}\label{movie-genres-effect}

\hfill\break

The plot below shows strong evidence of a genre effect (for illustrative
purposes, the plot shows only categories with more than 20, 000
ratings).

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Preparing data for plotting:}
\NormalTok{genre\_ratins\_grp }\OtherTok{\textless{}{-}}\NormalTok{ train\_set }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{genre\_categories =} \FunctionTok{as.factor}\NormalTok{(genres)) }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{group\_by}\NormalTok{(genre\_categories) }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{summarize}\NormalTok{(}\AttributeTok{n =} \FunctionTok{n}\NormalTok{(), }\AttributeTok{rating\_avg =} \FunctionTok{mean}\NormalTok{(rating), }\AttributeTok{se =} \FunctionTok{sd}\NormalTok{(rating)}\SpecialCharTok{/}\FunctionTok{sqrt}\NormalTok{(}\FunctionTok{n}\NormalTok{())) }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{filter}\NormalTok{(n }\SpecialCharTok{\textgreater{}} \DecValTok{20000}\NormalTok{) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{genres =} \FunctionTok{reorder}\NormalTok{(genre\_categories, rating\_avg)) }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{select}\NormalTok{(genres, rating\_avg, se, n)}

\FunctionTok{dim}\NormalTok{(genre\_ratins\_grp)}
\NormalTok{genre\_ratins\_grp\_sorted }\OtherTok{\textless{}{-}}\NormalTok{ genre\_ratins\_grp }\SpecialCharTok{|\textgreater{}} \FunctionTok{sort\_by.data.frame}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\NormalTok{ rating\_avg)}
\FunctionTok{print}\NormalTok{(genre\_ratins\_grp\_sorted)}

\CommentTok{\# Creating plot:}
\NormalTok{genre\_ratins\_grp }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{ggplot}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ genres, }\AttributeTok{y =}\NormalTok{ rating\_avg, }\AttributeTok{ymin =}\NormalTok{ rating\_avg }\SpecialCharTok{{-}} \DecValTok{2}\SpecialCharTok{*}\NormalTok{se, }\AttributeTok{ymax =}\NormalTok{ rating\_avg }\SpecialCharTok{+} \DecValTok{2}\SpecialCharTok{*}\NormalTok{se)) }\SpecialCharTok{+} 
  \FunctionTok{geom\_point}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{geom\_errorbar}\NormalTok{() }\SpecialCharTok{+} 
  \FunctionTok{ggtitle}\NormalTok{(}\StringTok{"Average rating per Genre"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{ylab}\NormalTok{(}\StringTok{"Average rating"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}\AttributeTok{axis.text.x =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{angle =} \DecValTok{90}\NormalTok{, }\AttributeTok{hjust =} \DecValTok{1}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

Below are worst and best ratings categories:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sprintf}\NormalTok{(}\StringTok{"The worst ratings are for the genre category: \%s"}\NormalTok{,}
\NormalTok{        genre\_ratins\_grp}\SpecialCharTok{$}\NormalTok{genres[}\FunctionTok{which.min}\NormalTok{(genre\_ratins\_grp}\SpecialCharTok{$}\NormalTok{genres)])}

\FunctionTok{sprintf}\NormalTok{(}\StringTok{"The best ratings are for the genre category: \%s"}\NormalTok{,}
\NormalTok{        genre\_ratins\_grp}\SpecialCharTok{$}\NormalTok{genres[}\FunctionTok{which.max}\NormalTok{(genre\_ratins\_grp}\SpecialCharTok{$}\NormalTok{genres)])}
\end{Highlighting}
\end{Shaded}

Another way of visualizing a genre effect is shown in the section
\href{https://www.kaggle.com/code/amirmotefaker/movie-recommendation-system-using-r-best/notebook\#Average-rating-for-each-genre}{Average
rating for each genre} of the article ``Movie Recommendation System
using R - BEST'' written by
\href{https://www.kaggle.com/amirmotefaker}{Amir
Moterfaker}\autocite{MRS-R-BEST}:

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# For better visibility, we reduce the data for plotting }
\CommentTok{\# while keeping the worst and best rating rows:}
\NormalTok{plot\_ind }\OtherTok{\textless{}{-}} \FunctionTok{odd}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(genre\_ratins\_grp))}
\NormalTok{plot\_dat }\OtherTok{\textless{}{-}}\NormalTok{ genre\_ratins\_grp\_sorted[plot\_ind,] }

\NormalTok{plot\_dat }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{ggplot}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ rating\_avg, }\AttributeTok{y =}\NormalTok{ genres)) }\SpecialCharTok{+}
  \FunctionTok{ggtitle}\NormalTok{(}\StringTok{"Genre Average Rating"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_bar}\NormalTok{(}\AttributeTok{stat =} \StringTok{"identity"}\NormalTok{, }\AttributeTok{width =} \FloatTok{0.6}\NormalTok{, }\AttributeTok{fill =} \StringTok{"\#8888ff"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{xlab}\NormalTok{(}\StringTok{"Average ratings"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{ylab}\NormalTok{(}\StringTok{"Genres"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{scale\_x\_continuous}\NormalTok{(}\AttributeTok{labels =}\NormalTok{ comma, }\AttributeTok{limits =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.0}\NormalTok{, }\FloatTok{5.0}\NormalTok{)) }\SpecialCharTok{+}
  \FunctionTok{theme\_economist}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}\AttributeTok{plot.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{vjust =} \FloatTok{3.5}\NormalTok{),}
        \AttributeTok{axis.title.x =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{vjust =} \SpecialCharTok{{-}}\DecValTok{5}\NormalTok{, }\AttributeTok{face =} \StringTok{"bold"}\NormalTok{),}
        \AttributeTok{axis.title.y =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{vjust =} \DecValTok{10}\NormalTok{, }\AttributeTok{face =} \StringTok{"bold"}\NormalTok{),}
        \AttributeTok{axis.text.x =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{vjust =} \DecValTok{1}\NormalTok{, }\AttributeTok{hjust =} \DecValTok{1}\NormalTok{, }\AttributeTok{angle =} \DecValTok{0}\NormalTok{),}
        \AttributeTok{axis.text.y =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{vjust =} \FloatTok{0.25}\NormalTok{, }\AttributeTok{hjust =} \DecValTok{1}\NormalTok{, }\AttributeTok{size =} \DecValTok{8}\NormalTok{),}
        \AttributeTok{plot.margin =} \FunctionTok{margin}\NormalTok{(}\FloatTok{0.7}\NormalTok{, }\FloatTok{0.5}\NormalTok{, }\DecValTok{1}\NormalTok{, }\FloatTok{1.2}\NormalTok{, }\StringTok{"cm"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

If we define \(g_{i,j}\) as the genre for user's \(i\) rating of movie
\(j\), we can use the following models to account for the \texttt{genre}
effect:

To account for \emph{genre effects} we will use the model suggested in
the
\href{https://rafalab.dfci.harvard.edu/dsbook-part-2/highdim/regularization.html\#exercises}{Section
23.7: Exercises} of the \emph{Chapter ``23 Regularization'' of the
Course Textbook}\autocite{IDS2_23-7}:

\[
Y_{i,j} = \mu + \alpha_i + \beta_j + g_{i,j} + \varepsilon_{i,j}
\]

where \(g_{i,j}\) is an \emph{aggregation function} which is explained
in detail in \emph{Section 22.3: ``Review of Aggregation Functions'' of
``Recommender Systems Handbook''} (\emph{Chapter 22: ``Aggregation of
Preferences in Recommender Systems''}, p.~712)
book\autocite{RRSK_RS_HB}.

In the formula above \(g_{i,j}\) denotes a \emph{genre effect} for
user's \(i\) rating of movie \(j\), so that:

\[
g_{i,j} = \sum_{k=1}^K x_{i,j}^k \gamma_k
\]

with \(x^k_{i,j} = 1\) if \(g_{i,j}\) includes genre \(k\), and
\(x^k_{i,j} = 0\) otherwise.

\[
Y_{i,j} = \mu + \alpha_i + \beta_j + g_{i,j} + f(d_{i,j})
\]

\[
 \sum_{i=1}^{n_i} \left(Y_{i,j} - \mu - \alpha_i\right)
\]

\subsection{Conclusion}\label{conclusion}

Hello Conclusion!

This is a great conclusion, isn't it?!!

\printbibliography

\end{document}
