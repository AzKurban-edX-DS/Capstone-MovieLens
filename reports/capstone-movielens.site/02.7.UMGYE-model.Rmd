## User+Movie+Genre+Year Effect (UMGYE) Model
\

### Year Effect Analysis

::: {.noteblock data-latex=""}
The _Year Effect_ visualization and analysis code in this section are cited from the article [Movie Recommendation System using R - BEST](https://www.kaggle.com/code/amirmotefaker/movie-recommendation-system-using-r-best/notebook) mentioned earlier in this report[@MRS-R-BEST].
:::

#### Yearly rating count[@MRS-R-BEST]
\
```{r}
print(edx |> 
  mutate(year = year(as_datetime(timestamp, origin = "1970-01-01"))) |>
  group_by(year) |>
  summarize(count = n())
)
```

#### Average rating per year plot[@MRS-R-BEST]
\
```{r}
edx |> 
  mutate(year = year(as_datetime(timestamp, origin = "1970-01-01"))) |>
  group_by(year) |>
  summarize(rating_avg = mean(rating)) |>
  ggplot(aes(x = year, y = rating_avg)) +
  geom_bar(stat = "identity", fill = "#8888ff") + 
  ggtitle("Average rating per year") +
  xlab("Year") +
  ylab("Average rating") +
  scale_y_continuous(labels = comma) + 
  theme_economist() +
  theme(axis.title.x = element_text(vjust = -5, face = "bold"), 
        axis.title.y = element_text(vjust = 10, face = "bold"), 
        plot.margin = margin(0.7, 0.5, 1, 1.2, "cm"))
```

\newpage

### Mathematical Description of the UMGYE Model
\

If we define $\gamma(q)$ as the _year effect_ for the year (which is denotes by $q$ here) of rating a movie $j$ by a user $i$, the formula \@ref(eq:UMGE-model) describing the _UMGE Model_, for the current model, takes the following form:

\begin{equation}
Y_{i,j} = \mu + \alpha_i + \beta_j + g_{i,j} + \gamma(q) + \varepsilon_{i,j}
(\#eq:UMGYE-model)
\end{equation}


Therefore, the formula \@ref(eq:genre-effect) for calculation the prediction of a _genre effect_ as a residual, for a _year effect_ 
$$
\hat{\gamma}(q) = \gamma(q) + \varepsilon_{i,j}
$$

takes the following form: 

\begin{equation}
\hat{\gamma}(q) = Y_{i,j} - (\mu + \alpha_i + \beta_j + g_{i,j})
(\#eq:year-effect)
\end{equation}

### UMGYE Model: Support Functions
\

::: {.noteblock data-latex=""}
Some of the functions described in this section accepts the `lambda` parameter, which we will need later for the _Model Regularization_ method. We also use the [mean_reg](https://github.com/AzKurban-edX-DS/Capstone-MovieLens/blob/main/r/src/support-functions/common-helper.functions.R#L63) function call, which we will need later for the *Regularization* techniques (for details, see the  [mean_reg](#func.mean_reg) function description in the Section [Regularization: Common Helper Functions](#appndx_a.rglr.common_helper.functions) section of the [Appendix] to this report).
We have already explained that in the [UMGYE Effect Model Regularization] section. 
For now, we omit the `lambda` parameter, accepting its default value `lambda = 0`. Let's recall that in this case, the [mean_reg](#func.mean_reg) function is equivalent to the standard R function [base::mean](https://www.rdocumentation.org/packages/base/versions/3.6.2/topics/mean).
:::

#### [](https://github.com/AzKurban-edX-DS/Capstone-MovieLens/blob/main/r/src/support-functions/UMGY-effect.functions.R#L) Function {#func.}
\

```{r eval=FALSE}
```

::: {.noteblock data-latex=""}
Note
:::

#### [](https://github.com/AzKurban-edX-DS/Capstone-MovieLens/blob/main/r/src/support-functions/UMGY-effect.functions.R#L) Function {#func.}
\

```{r eval=FALSE}
```

::: {.noteblock data-latex=""}
Note
:::

#### [](https://github.com/AzKurban-edX-DS/Capstone-MovieLens/blob/main/r/src/support-functions/UMGY-effect.functions.R#L) Function {#func.}
\

```{r eval=FALSE}
```

::: {.noteblock data-latex=""}
Note
:::

#### [](https://github.com/AzKurban-edX-DS/Capstone-MovieLens/blob/main/r/src/support-functions/UMGY-effect.functions.R#L) Function {#func.}
\

```{r eval=FALSE}
```

::: {.noteblock data-latex=""}
Note
:::

#### [](https://github.com/AzKurban-edX-DS/Capstone-MovieLens/blob/main/r/src/support-functions/UMGY-effect.functions.R#L) Function {#func.}
\

```{r eval=FALSE}
```

::: {.noteblock data-latex=""}
Note
:::

#### [calc_date_general_effect](https://github.com/AzKurban-edX-DS/Capstone-MovieLens/blob/main/r/src/support-functions/UMGY-effect.functions.R#L2) Function {#func.calc_date_general_effect}
\

This is a helper function that calculates the _date general effect_ of the user ratings and is intended to be used in other functions and scripts (for instance in [train_UMGY_effect](#func.train_UMGY_effect)) described below.

The following is a slightly simplified version of the function's source code:
```{r eval=FALSE}
calc_date_general_effect <- function(train_set, lambda = 0){
  if (is.na(lambda)) {
    stop("Function: calc_date_general_effect
`lambda` is `NA`")
  }
  
  if(lambda == 0) put_log("Function `calc_date_general_effect`:
Computing Date Global Effect for given Train Set data...")
  else put_log1("Function `calc_date_general_effect`:
Computing Date Global Effect for lambda: %1...",
                lambda)
  dg_effect <- train_set |> 
    left_join(edx.user_effect, by = "userId") |>
    left_join(rglr.UM_effect, by = "movieId") |>
    left_join(rglr.UMG_effect, by = "movieId") |>
    left_join(date_days_map, by = "timestamp") |>
    mutate(resid = rating - (mu + a + b + g)) |>
    # filter(!is.na(resid)) |>
  group_by(days) |>
    summarise(de = mean_reg(resid, lambda), 
              year = mean(year))
  dg_effect
}
```

::: {.noteblock data-latex=""}
The complete version of the source code of the [calc_date_general_effect](https://github.com/AzKurban-edX-DS/Capstone-MovieLens/blob/main/r/src/support-functions/UMGY-effect.functions.R#L2) function is available in the [UMGYE Model Support Functions](#L1) section of the [UMGY-effect.functions.R](https://github.com/AzKurban-edX-DS/Capstone-MovieLens/blob/main/r/src/support-functions/UMGY-effect.functions.R#L2) script on _GitHub.
:::

#### [calc_UMGY_effect](https://github.com/AzKurban-edX-DS/Capstone-MovieLens/blob/main/r/src/support-functions/UMGY-effect.functions.R#L73) Function {#func.calc_UMGY_effect}
\

This is a helper function that calculates the _UMGY effect_ of the user ratings and is intended to be used in other functions and scripts (for instance in [train_UMGY_effect](#func.train_UMGY_effect)) described below.

##### Parameters
\

The function accepts the only parameter `date_general_effect`, which is a data structure returned by the [calc_date_general_effect](#func.calc_date_general_effect) function described above.

##### Source Code
\

The following is the source code of the function:
```{r eval=FALSE}
calc_UMGY_effect <- function(date_general_effect){
  date_general_effect |>
    group_by(year) |>
    summarise(ye = mean(de, na.rm = TRUE))
}
```


::: {.noteblock data-latex=""}
The source code of the [calc_UMGY_effect](https://github.com/AzKurban-edX-DS/Capstone-MovieLens/blob/main/r/src/support-functions/UMGY-effect.functions.R#L73) function is also available in the [UMGYE Model Support Functions](https://github.com/AzKurban-edX-DS/Capstone-MovieLens/blob/main/r/src/support-functions/UMGY-effect.functions.R#L1) section of the [UMGY-effect.functions.R](https://github.com/AzKurban-edX-DS/Capstone-MovieLens/blob/main/r/src/support-functions/UMGY-effect.functions.R#L73) script on _GitHub.
:::

#### [train_UMGY_effect](https://github.com/AzKurban-edX-DS/Capstone-MovieLens/blob/main/r/src/support-functions/UMGY-effect.functions.R#L78) Function {#func.train_UMGY_effect}
\

This function is used to train the current model using the _Train Set_ dataset passed in the `train_set` parameter.
The following is the source code of the function:
```{r eval=FALSE}
train_UMGY_effect <- function(train_set, lambda = 0){
  if (is.na(lambda)) {
    stop("Function: train_UMGY_effect
`lambda` is `NA`")
  }
  
  train_set |>
    calc_date_general_effect(lambda) |>
    calc_UMGY_effect()
}

```

::: {.noteblock data-latex=""}
The source code of the [train_UMGY_effect](https://github.com/AzKurban-edX-DS/Capstone-MovieLens/blob/main/r/src/support-functions/UMGY-effect.functions.R#L78) function is also available in the [UMGYE Model Support Functions](https://github.com/AzKurban-edX-DS/Capstone-MovieLens/blob/main/r/src/support-functions/UMGY-effect.functions.R#L1) section of the [UMGY-effect.functions.R](https://github.com/AzKurban-edX-DS/Capstone-MovieLens/blob/main/r/src/support-functions/UMGY-effect.functions.R#L78) script on _GitHub.
:::

#### [train_UMGY_effect.cv](https://github.com/AzKurban-edX-DS/Capstone-MovieLens/blob/main/r/src/support-functions/UMGY-effect.functions.R#L88) Function {#func.train_UMGY_effect.cv}
\

This function is used to train the current model using the _5-Fold Cross Validation_ method.
The following is the source code of the function:
```{r eval=FALSE}
train_UMGY_effect.cv <- function(lambda = 0){
  if (is.na(lambda)) {
    stop("Function: train_UMGY_effect.cv
`lambda` is `NA`")
  }
  
  calc_date_general_effect.cv(lambda) |> calc_UMGY_effect()  
}
```

::: {.noteblock data-latex=""}
Here we use the function call [union_cv_results](https://github.com/AzKurban-edX-DS/Capstone-MovieLens/blob/main/r/src/support-functions/data.helper.functions.R#L432) to aggregate the _5-Fold Cross Validation_ method results (for details, see the [union_cv_results](#func.union_cv_results) function description in the [Data Helper Functions](#appndx_a.data_helper.functions) section of the [Appendix] to this report).
:::

#### `calc_UMGY_effect_MSE` Function
\

The source code of the function [calc_UMGY_effect_MSE](https://github.com/AzKurban-edX-DS/Capstone-MovieLens/blob/main/r/src/support-functions/UMGY-effect.functions.R#L) defined in the [](https://github.com/AzKurban-edX-DS/Capstone-MovieLens/blob/main/r/src/support-functions/) script to calculate the _Mean Squared Error (MSE)_ of the _UMGYE Model_ for the given _Test Set_ is provided below:
```{r eval=FALSE}
```

\newpage

#### `calc_UMGY_effect_MSE.cv` Function
\

The source code of the function [calc_UMGY_effect_MSE.cv](https://github.com/AzKurban-edX-DS/Capstone-MovieLens/blob/main/r/src/support-functions/UMGY-effect.functions.R#L) defined in the [](https://github.com/AzKurban-edX-DS/Capstone-MovieLens/blob/main/r/src/support-functions/) script to calculate the _5-Fold Cross Validation MSE_ result of the _UMGYE Model_ is provided below:
```{r eval=FALSE}
```


#### `calc_UMGY_effect_RMSE` Function
\

The source code of the function [calc_UMGY_effect_RMSE](https://github.com/AzKurban-edX-DS/Capstone-MovieLens/blob/main/r/src/support-functions/UMGY-effect.functions.R#L118) defined in the [](https://github.com/AzKurban-edX-DS/Capstone-MovieLens/blob/main/r/src/support-functions/) script to calculate the _Root Mean Squared Error (RMSE)_ of the _UMGYE Model_ for the given _Test Set_ is provided below:

```{r eval=FALSE}
```

#### `calc_UMGY_effect_RMSE.cv` Function { #func.calc_UMGY_effect_RMSE.cv }
\

The source code of the function [calc_UMGY_effect_RMSE.cv](https://github.com/AzKurban-edX-DS/Capstone-MovieLens/blob/main/r/src/support-functions/UMGY-effect.functions.R#L) defined in the [](https://github.com/AzKurban-edX-DS/Capstone-MovieLens/blob/main/r/src/support-functions/) script to calculate the _5-Fold Cross Validation **RMSE**_ result of the _UMGYE Model_ is provided below:

```{r eval=FALSE}
```

\newpage

### UMGYE Model Building
\

::: {.noteblock data-latex=""}
The complete source code of builing and training the current model is available in the [Model building: UMGYE Effect](https://github.com/AzKurban-edX-DS/Capstone-MovieLens/blob/main/r/src/capstone-movielens.main.R#L) section of the [capstone-movielens.main.R](https://github.com/AzKurban-edX-DS/Capstone-MovieLens/blob/main/r/src/capstone-movielens.main.R) script on _GitHub_.
:::

Below, we provide the most significant part of the code for training our model using the `5-Fold Cross Validation` method:
```{r, eval=FALSE}
```

\newpage

We can now construct predictors and calculate the _RMSE_ of the current model using the [calc_UMGY_effect_RMSE.cv](#func.calc_UMGY_effect_RMSE.cv) function described above:

```{r, eval=FALSE}
cv.UMG_effect.RMSE <- calc_UMGY_effect_RMSE.cv(cv.UMG_effect)

RMSEs.ResultTibble.UMGYE <- RMSEs.ResultTibble.rglr.UMGYE |> 
  RMSEs.AddRow("UMGYE Effect (UMGYE) Model", cv.UMG_effect.RMSE,
               comment = "Comment")
```
```{r}
RMSE_kable(RMSEs.ResultTibble.UMGYE)
```


::: {.noteblock data-latex=""}
Hello Note!!!
:::

\newpage


### UMGYE Effect Model Regularization
\

We have already explained the idea of the _Linear Model Regularization_ in the [UME Model Regularization] section above. Let's extend the concept outlined there to our current model.


In this case, the formula \@ref(eq:ME-penalty) for adding a penalty takes the following form:

\begin{equation}
\sum_{i,j} \left(y_{u,i} - \mu - \alpha_i - \beta_j - ...\right)^2 + \lambda \sum_{j} \beta_j^2 
(\#eq:YE-penalty)
\end{equation}

And the formula \@ref(eq:ME-regularized) for calculating the values of the _treatment effect_ that minimize the equation takes the following form:

\begin{equation}
\hat{\beta}_j(\lambda) = \frac{1}{\lambda + n_j} \sum_{i=1}^{n_i} \left(Y_{i,j} - \mu - \alpha_i\right)
(\#eq:YE-regularized)
\end{equation}

where $n_y$ is the number of ratings made in year $y$. 

As stated in the [UME Model Regularization] section, we will implement the _Regularization_ method on our  current model in three steps: 

  1. **Pre-configuration:** Preliminary determination of the optimal range of $\lambda$ values for the `5-Fold Cross Validation` samples;
  
  2. **Fine-tuning:** figuring out the value of $\lambda$ that minimizes the model's RMSE.
  
  3. **Retraining:** retraining the model with the best value of the parameter $\lambda$ obtained in the previous step.


\newpage

#### UMGYE Model Regularization: Support Functions
\

::: {.noteblock data-latex=""}
The [regularize.test_lambda.UMGY_effect.cv]() function described below are defined in the [Regularization]() section of the [UM-effect.functions.R]() script.
:::

##### [regularize.test_lambda.UMGY_effect.cv](https://github.com/AzKurban-edX-DS/Capstone-MovieLens/blob/main/r/src/support-functions/UMGY-effect.functions.R#L96) Function {#func.regularize.test_lambda.UMGY_effect.cv}
\

This function calculates _RMSE_ of the _UMGYE Model_ using _5-Fold Cross Validation_ method for the given $\lambda$ parameter value:
```{r, eval=FALSE}
```

::: {.noteblock data-latex=""}
Note that we reuse the function [train_UMGY_effect.cv](#func.train_UMGY_effect.cv) calling it from the [regularize.test_lambda.UMGY_effect.cv](#func.regularize.test_lambda.UMGY_effect.cv), but now with the $\lambda$ parameter different from the default ('lambda = 0') value.
:::

\newpage

#### UMGYE Model Regularization: Pre-configuration
\

Let's perform the preconfiguration to determine the appropriate range of $\lambda$ for subsequent fine-tuning of our current model:

We are going to use the [tune.model_param](#func.tune.model_param) function described in the [Regularization: Common Helper Functions](#appndx_a.rglr.common_helper.functions) section of the [Appendix] to this report, passing the [regularize.test_lambda.UMGY_effect.cv](#func.regularize.test_lambda.UMGY_effect.cv) function as the value of the [fn_tune.test.param_value](#func.tune.model_param.params.fn_tune.test.param_value) parameter:

```{r, eval=FALSE}
```
```{r}
str(cv.UMGYE.preset.result)
cv.UMGYE.preset.result$best_result
```

::: {.noteblock data-latex=""}
The complete version of the source code provided in this section can be found in the [UMGYE Model Regularization: Pre-configuration](https://github.com/AzKurban-edX-DS/Capstone-MovieLens/blob/main/r/src/capstone-movielens.main.R#L) section of the [capstone-movielens.main.R](https://github.com/AzKurban-edX-DS/Capstone-MovieLens/blob/main/r/src/capstone-movielens.main.R) script.
:::

Now, let's visualize the results of the $\lambda$ range preconfiguration:
``` {r}
# title = TeX(r'[UMGE Model Regularization: $\lambda$ Range Pre-configuration]')
```

::: {.noteblock data-latex=""}
We use the custom data visualization function [data.plot](#func.data.plot) described in the [Data Helper Functions](#appndx_a.data_helper.functions) section of the [Appendix] to this report, which is defined in the [Data Visualization](https://github.com/AzKurban-edX-DS/Capstone-MovieLens/blob/main/r/src/support-functions/data.helper.functions.R#L447) section of the [data.helper.functions.R](https://github.com/AzKurban-edX-DS/Capstone-MovieLens/blob/main/r/src/support-functions/data.helper.functions.R#L592) script on _GitHub_.
:::

\newpage

#### UMGYE Model Regularization: Fine-tuning
\

We are now ready to perform the fine-tuning step of our model _regularization_ process to determine the best value for the $\lambda$ parameter.

Here we are going to use the [model.tune.param_range](#func.model.tune.param_range) function described in the [Regularization: Common Helper Functions](#appndx_a.rglr.common_helper.functions) section of the [Appendix] to this report, passing the [regularize.test_lambda.UMGY_effect.cv](#func.regularize.test_lambda.UMGY_effect.cv) function as the value of the [fn_tune.test.param_value](#func.model.tune.param_range.params.fn_tune.test.param_value) parameter:
```{r, eval=FALSE}
```
```{r}
str(UMGYE.rglr.fine_tune.results)
UMGYE.rglr.fine_tune.results$best_result
```

::: {.noteblock data-latex=""}
The complete version of the source code provided in this section can be also found in the [Fine-tuning Step of the Regularization Method for the User+Movie Model](https://github.com/AzKurban-edX-DS/Capstone-MovieLens/blob/main/r/src/capstone-movielens.main.R#L867) section of the [capstone-movielens.main.R](https://github.com/AzKurban-edX-DS/Capstone-MovieLens/blob/main/r/src/capstone-movielens.main.R) script on _GitHub_.
:::

Let's visualize the fine-tuning results:
```{r}
```
\newpage

#### UMGYE Model Regularization: Retraining Model with the best $\lambda$
\

Now, we can calculate the _Regularized UMGYE Effect_ by retraining our model on the entire `edx` dataset with the best value of the $\lambda$ parameter we just calculated, for the definitive _Root Mean Squared Error_ calculation and use in subsequent models.
```{r, eval=FALSE}
```

::: {.noteblock data-latex=""}
The complete version of the source code provided in this section are available in the [Re-training Regularized UMGYE Effect Model for the best $\lambda$](https://github.com/AzKurban-edX-DS/Capstone-MovieLens/blob/main/r/src/capstone-movielens.main.R#L910) section of the [capstone-movielens.main.R](https://github.com/AzKurban-edX-DS/Capstone-MovieLens/blob/main/r/src/capstone-movielens.main.R#L910) script on _GitHub_.
:::

We calculate the _Root Mean Squared Error_ for the ultimately computed _UMGYE Effect_ using [calc_UMGY_effect_RMSE.cv](#func.calc_UMGY_effect_RMSE.cv) function described above as follows:
```{r, eval=FALSE}
```

Finally, we add the definitive result for the current model to our _Result Table_:
```{r, eval=FALSE}
RMSEs.ResultTibble.rglr.UMGYE <- RMSEs.ResultTibble.UMGYE |> 
  RMSEs.AddRow("Regularized UMGYE Effect Model", 
               UMGYE.rglr.retrain.RMSE,
               comment = "Computed for `lambda` = %1" |>
                 msg.glue(UMGYE.rglr.best_lambda))
```
```{r}
RMSE_kable(RMSEs.ResultTibble.rglr.UMGYE)
```

\newpage

