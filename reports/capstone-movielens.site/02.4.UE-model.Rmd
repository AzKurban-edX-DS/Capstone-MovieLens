## User Effect (UE) Model
\

### User Effect Anasysis
\

To improve our model let's now take into consideration user effects as explained in [Section 24.1 *Case study: recommendation systems / User effects*](https://rafalab.dfci.harvard.edu/dsbook-part-2/highdim/regularization.html#user-effects) of the *Course Textbook (New Edition)*.

If we visualize the average rating for each user the way the the author shows, we can see that there is substantial variability in the average ratings across users[@IDS2_24-1]: 
```{r}
hist(edx.user_mean_ratings$mean_rating,
     xlab = "User Average Rating",
     main = "Histogram of User Average Rating",
     nclass = 30)
```

\newpage

### Mathematical Description of the UE Model
\

Following the *Course Textbook* author's [further explanation](https://rafalab.dfci.harvard.edu/dsbook-part-2/highdim/regularization.html#user-effects), to account for this variability, we will use a linear model with a _treatment effect_  $\alpha_i$ for each user. The sum $\mu+\alpha_i$ can be interpreted as the typical rating user $i$ gives to movies. So we write the model as follows:

$$
Y_{i,j} = \mu + \alpha_i + \varepsilon_{i,j}
$$

Statistics textbooks refer to the $\alpha$s as treatment effects. In the Netflix challenge papers, they refer to them as _bias_[@IDS2_24-1; @MFT_RS].

### UE Model Building
\

::: {.noteblock data-latex=""}
The complete source code of the _User Effect_ computation described in this section is available in the [User Effect (UE) Model](https://github.com/AzKurban-edX-DS/Capstone-MovieLens/blob/main/r/src/capstone-movielens.main.R#L210) section of the [capstone-movielens.main.R](https://github.com/AzKurban-edX-DS/Capstone-MovieLens/blob/main/r/src/capstone-movielens.main.R#L210) script on _GitHub_.
:::

As it is stated in the [Course Textbook](https://rafalab.dfci.harvard.edu/dsbook-part-2/highdim/regularization.html#user-effects), it can be shown that the least squares estimate $\hat{\alpha}_i$ is just the average of $y_{i,j} - \hat{\mu}$ for each user $i$. So we can compute them this way[@IDS2_24-1]:
```{r eval=FALSE}
a <- rowMeans(y - mu, na.rm = TRUE)
```

These considerations allow us to compute a _User Mean Ratings_ using the following [piece code](https://github.com/AzKurban-edX-DS/Capstone-MovieLens/blob/main/r/src/capstone-movielens.main.R#L231):
```{r  main-script@l1231, eval=FALSE}
put_log("Computing Average Ratings per User (User Mean Ratings)...")
user.mean_ratings <- rowMeans(edx.mx, na.rm = TRUE)
user_ratings.n <- rowSums(!is.na(edx.mx))
  
edx.user_mean_ratings <- 
  data.frame(userId = names(user.mean_ratings), 
             mean_rating = user.mean_ratings,
             n = user_ratings.n)
  
put_log("User Mean Ratings have been computed.")
```
```{r}
str(edx.user_mean_ratings)
```

\newpage

And then we compute a _User Effect_ using the following [piece of code](https://github.com/AzKurban-edX-DS/Capstone-MovieLens/blob/main/r/src/capstone-movielens.main.R#L291):
```{r main-script@l291, eval=FALSE}
edx.user_effect <- edx.user_mean_ratings |>
  mutate(userId = as.integer(userId),
         a = mean_rating - mu)
```
```{r}
str(edx.user_effect)
```

The following [code snippet](https://github.com/AzKurban-edX-DS/Capstone-MovieLens/blob/main/r/src/capstone-movielens.main.R#L336) plots a histogram that provides a visual representation of the *User Effect* data object we have just obtained:
```{r main-script@l336}
par(cex = 0.7)
hist(edx.user_effect$a, 30, xlab = TeX(r'[$\hat{alpha}_{i}$]'),
     main = TeX(r'[Histogram of $\hat{alpha}_{i}$]'))

```

Now, we are ready to compute the *Mean Squared Errors (MSE)* for samples used in _K-Fold Cross-Validation_ (additionally using the [clamp](#func.clamp) helper function (described in the [Utility Functions] section of [Appendix A](#appndx_a)).

::: {.noteblock data-latex=""}
The $K$ value for the *K-Fold Cross-Validation* method is determined by the length of the [`edx_CV` Object] described below in the [Appendix B: Models Training Datasets] (in *this Project* we use $K = 5$).
:::

The [code snippet](https://github.com/AzKurban-edX-DS/Capstone-MovieLens/blob/main/r/src/capstone-movielens.main.R#L345) that performs this operation is shown below:
```{r main-script@l345, eval=FALSE}
put_log("Computing the RMSE taking into account user effects...")
edx.user_effect.MSEs <- sapply(edx_CV, function(cv_fold_dat){
  cv_fold_dat$validation_set |>
    left_join(edx.user_effect, by = "userId") |>
    mutate(resid = rating - clamp(mu + a)) |> 
    pull(resid) |> mse()
})
```

The following [code snippet](https://github.com/AzKurban-edX-DS/Capstone-MovieLens/blob/main/r/src/capstone-movielens.main.R#L355) visualizes the results obtained above:
```{r main-script@l355}
data.frame(fold_No = 1:5, MSE = edx.user_effect.MSEs) |>
  data.plot(title = "MSE resuls of the 5-fold CV method applied to the User Effect Model",
            xname = "fold_No", 
            yname = "MSE")

```

::: {.noteblock data-latex=""}
In the code snippet above, we use the custom data visualization function [data.plot](#func.data.plot) described in the [Data Helper Functions]/[Data Visualization Functions] section of [Appendix A](#appndx_a).
:::

We can now calculate the *RMSE* for the current model as a *square root* of the average of the *MSE* values we obtained above, using the following [line of code](https://github.com/AzKurban-edX-DS/Capstone-MovieLens/blob/main/r/src/capstone-movielens.main.R#L364):
```{r main-script@l364, eval=FALSE}
edx.user_effect.RMSE <- sqrt(mean(edx.user_effect.MSEs))
```

\newpage

Finally, we add the *RMSE* value calculated for the *UE Model* to our *Result Table* and print the table using the following [piece of code](https://github.com/AzKurban-edX-DS/Capstone-MovieLens/blob/main/r/src/capstone-movielens.main.R#L372):
```{r main-script@l372, eval=FALSE}
RMSEs.ResultTibble.UE <- RMSEs.ResultTibble.OMR |> 
  RMSEs.AddRow("UE Model", 
               edx.user_effect.RMSE,
               comment = "User Effect (UE) Model")
```
```{r}
RMSE_kable(RMSEs.ResultTibble.UE)
```

::: {.noteblock data-latex=""}
In the code snippet above, we use the [RMSEs.AddRow](#func.RMSEs.AddRow) and [RMSE_kable](#func.RMSE_kable) functions described in the [Common Helper Functions]/[Result RMSEs Tibble Functions] section of [Appendix A](#appndx_a).
:::

\newpage
